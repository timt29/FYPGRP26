<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ article.title }} — EchoPress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" type="image/png" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subscriber.css') }}">
</head>
<body>

  <!-- Top Bar -->
  <header class="topbar">
    <div class="left">
      <a href="{{ url_for('subscriberHomepage') }}" class="brand">
        <img src="{{ url_for('static', filename='img/echopresslogo.png') }}" alt="EchoPress" />
      </a>
      <form class="search" action="#" method="get" role="search">
        <input type="text" placeholder="Searching for… ?" aria-label="Search" />
        <button type="submit" aria-label="Search">Search</button>
      </form>
    </div>

    <div class="right">
      <span class="welcome">Welcome, {{ session.get('user','Subscriber') }} !</span>
      <button id="menuBtn" class="burger" aria-label="Menu"><span></span><span></span><span></span></button>
      <div id="menuPanel" class="menu-panel">
        <a href="/bookmarks">View Bookmark</a>
        <a href="/my-articles">View My Articles</a>
        <a href="/analytics">View Analytics</a>
        <a href="/profile">Edit Profile</a>
        <a href="#" class="logout-link">Log Out</a>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="tabs">
    <div class="tabs-inner">
      <a href="#" class="tab">For you</a>
      <a href="#" class="tab active">Trending</a>
      <a href="#" class="tab">Politics</a>
      <a href="#" class="tab">Sports</a>
      <a href="#" class="tab">Technology</a>
      <a href="#" class="tab">Economic</a>
      <a href="#" class="tab">AsiaNews</a>
      <a href="#" class="tab">WorldNews</a>
    </div>
  </nav>

  <!-- Two-column layout -->
  <main class="page">
    <!-- LEFT: Article -->
    <section class="feed">

<article class="article-card detail" style="padding:22px;">
  <!-- Title with kebab on the right -->
  <div class="article-header">
    <h1 style="margin:6px 0 8px 0; text-align:center;">{{ article.title }}</h1>

    {% if is_pinned %}
      <span id="pinnedBadge" class="badge-pinned">Pinned</span>
    {% else %}
      <span id="pinnedBadge" class="badge-pinned" style="display:none;">Pinned</span>
    {% endif %}

    <div class="kebab-wrap">
      <button class="kebab-btn" id="kebabBtn" aria-haspopup="true" aria-expanded="false">
        <span class="kebab-dot" aria-hidden="true"></span>
      </button>
      <div class="kebab-menu" id="kebabMenu" role="menu" aria-label="Article actions">
        <button id="pinItem" role="menuitem">
          {% if is_pinned %}Unpin This Article{% else %}Pin This Article{% endif %}
        </button>
        <a role="menuitem" href="{{ url_for('create_article') }}?edit={{ article.slug }}">Edit Article</a>
      </div>
    </div>
  </div>

  <!-- Content row BELOW the header -->
  <div class="article-body">
    <div class="text">
      {% for para in article.paragraphs %}
        <p style="line-height:1.6; margin:0 0 12px 0; color:#333;">{{ para }}</p>
      {% endfor %}

      <div style="margin-top:18px; color:#666; font-size:.92rem;">
        <div><strong>{{ article.author }}</strong></div>
        <div>
          <span>Published on {{ article.published_at }}</span>
          {% if article.updated_at %} <span> • Updated on {{ article.updated_at }}</span>{% endif %}
        </div>
      </div>
    </div>

    {% if article.image_url %}
    <a class="thumb-wrap" aria-label="Article image">
      <img src="{{ article.image_url }}" alt="" class="thumb" />
    </a>
    {% endif %}
  </div>
</article>


      <!-- Comments (below article only) -->
      <section class="card" style="padding:18px; margin-top:16px;">
        <h3 style="margin:0 0 12px 0;">Comments</h3>

        <form id="commentForm" style="margin-bottom:18px;">
          <textarea id="commentInput" rows="3" placeholder="Insert comments"
                    style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;resize:vertical;"></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:8px;">
            <button type="submit" class="btn btn-primary">Send</button>
          </div>
        </form>

        <div id="commentList"></div>
      </section>
    </section>

    <!-- RIGHT: Sidebar -->
    <aside class="sidebar">
      <a href="{{ url_for('create_article') }}" class="btn btn-primary">Create Your Story</a>
      <div class="ads">Ads</div>
    </aside>
  </main>

  <!-- JS: comments (no persistence) -->
  <script>
    (function(){
      const form = document.getElementById('commentForm');
      const input = document.getElementById('commentInput');
      const list = document.getElementById('commentList');
      if(!form) return;

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        const div = document.createElement('div');
        div.style.cssText = "border:1px solid #eee;border-radius:8px;padding:12px;margin-bottom:12px;background:#fafafa;";
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>{{ session.get('user','Anonymous') }}</strong>
            <span style="color:#888;font-size:.9rem;">just now</span>
          </div>
          <p style="margin:8px 0 0 0;color:#333;white-space:pre-wrap;">${text}</p>
        `;
        list.prepend(div);
        input.value = '';
      });
    })();
  </script>

  <!-- JS: menu toggle (topbar) -->
  <script>
    (function(){
      const btn = document.getElementById('menuBtn');
      const panel = document.getElementById('menuPanel');
      if(!btn || !panel) return;
      function closeP(){ panel.style.display='none'; }
      function toggleP(){ panel.style.display = panel.style.display==='block' ? 'none' : 'block'; }
      btn.addEventListener('click', e => { e.stopPropagation(); toggleP(); });
      document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) closeP(); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeP(); });
    })();
  </script>

  <!-- JS: kebab + pin/unpin -->
  <script>
    (function(){
      const kebabBtn  = document.getElementById('kebabBtn');
      const kebabMenu = document.getElementById('kebabMenu');
      const pinItem   = document.getElementById('pinItem');
      const pinnedBadge = document.getElementById('pinnedBadge');
      const endpoint  = "{{ url_for('pin_article') }}";
      const slug      = "{{ article.slug }}";

      if(!kebabBtn) return;

      function openMenu(){
        kebabMenu.style.display = 'block';
        kebabBtn.setAttribute('aria-expanded', 'true');
      }
      function closeMenu(){
        kebabMenu.style.display = 'none';
        kebabBtn.setAttribute('aria-expanded', 'false');
      }
      kebabBtn.addEventListener('click', (e)=>{ e.stopPropagation(); 
        const open = kebabMenu.style.display === 'block';
        open ? closeMenu() : openMenu();
      });
      document.addEventListener('click', (e)=>{ if(!kebabMenu.contains(e.target)) closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

      // Pin/Unpin via API
      pinItem.addEventListener('click', async ()=>{
        try{
          const res = await fetch(endpoint, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ slug })
          });
          const data = await res.json();
          if(!data.ok) throw new Error(data.error || "Failed");
          const nowPinned = (data.state === "pin");
          pinItem.textContent = nowPinned ? "Unpin This Article" : "Pin This Article";
          pinnedBadge.style.display = nowPinned ? "inline-block" : "none";
          closeMenu();
        }catch(err){
          alert("Unable to update pin state. Please try again.");
        }
      });
    })();
  </script>

  <!-- Logout Confirmation Modal -->
<div id="logoutModal" class="modal-overlay">
  <div class="modal">
    <h2>Log Out?</h2>
    <div class="buttons">
      <button class="yes" id="confirmLogout">Yes</button>
      <button class="no" id="cancelLogout">No</button>
    </div>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById("logoutModal");
    const confirmBtn = document.getElementById("confirmLogout");
    const cancelBtn = document.getElementById("cancelLogout");

    // intercept logout links
    document.querySelectorAll(".logout-link").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        modal.style.display = "flex";
      });
    });

    confirmBtn.addEventListener("click", () => {
      window.location.href = "{{ url_for('logout') }}";
    });

    cancelBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // close modal on Escape key
    document.addEventListener("keydown", e => {
      if (e.key === "Escape") modal.style.display = "none";
    });
  })();
</script>

</body>
</html>
