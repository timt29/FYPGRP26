<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ article.title }} â€” EchoPress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" type="image/png" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/author.css') }}">
</head>
<body>

  <!-- Top Bar -->
  <header class="topbar">
    <div class="left">
      <a class="brand" href="{{ url_for('authorHomepage') }}">
        <img src="{{ url_for('static', filename='img/echopresslogo.png') }}" alt="EchoPress" />
        <span class="brand-text">EchoPress</span>
      </a>
      <form class="search"><input type="text" placeholder="Searching forâ€¦ ?"></form>
    </div>
    <div class="right">
      <span class="welcome">Welcome, {{ session.get('user','Author') }} !</span>
      <button id="menuBtn" class="burger" aria-label="Menu"><span></span><span></span><span></span></button>
      <div id="menuPanel" class="menu-panel">
        <a href="{{ url_for('authorHomepage') }}">Author Home</a>
        <a href="{{ url_for('my_articles') }}">My Articles</a>
        <a href="{{ url_for('analytics') }}">View Analytics</a>
        <a href="{{ url_for('profile') }}">Profile</a>
        <a href="#" class="logout-link">Log Out</a>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="tabs">
    <div class="tabs-inner">
      <a href="#" class="tab">For you</a>
      <a href="#" class="tab active">Trending</a>
      <a href="#" class="tab">Politics</a>
      <a href="#" class="tab">Sports</a>
      <a href="#" class="tab">Technology</a>
      <a href="#" class="tab">Economic</a>
      <a href="#" class="tab">AsiaNews</a>
      <a href="#" class="tab">WorldNews</a>
    </div>
  </nav>

  <main class="page">
    <section class="feed">

      <article class="story card">
        <div class="row-between" style="align-items:flex-start;margin-bottom:8px">
          <div>
            <h1 class="title" style="margin:0;display:inline">{{ article.title }}</h1>
            {% if is_pinned %}
              <span class="pin-badge" title="This article is pinned">ðŸ“Œ Pinned</span>
            {% endif %}
          </div>

        <!-- Kebab -->
        <div class="kebab-wrap">
          <button id="articleMenuBtn" class="kebab" aria-label="Article menu">
            <span></span><span></span><span></span>
          </button>
          <div id="articleMenuPanel" class="kebab-panel">
            <form method="post" action="{{ url_for('author_article2_toggle_pin') }}">
              <button class="kebab-item" type="submit">
                {{ "Unpin This Article" if is_pinned else "Pin This Article" }}
              </button>
            </form>
            <a class="kebab-item" href="{{ url_for('author_article2_edit') }}">Edit Article</a>
          </div>
        </div>
        </div>

        <div class="story-grid">
          <div class="copy">
            <div style="white-space:pre-wrap; line-height:1.6; color:#333;">{{ article.content }}</div>
          </div>
          <figure class="media">
            <img src="{{ url_for('static', filename=article.image_path) }}" alt="">
          </figure>
        </div>

        <!-- Author info -->
        <div class="author-meta">
          <div class="avatar">
            {% if profile and profile.avatar_url %}
              <img src="{{ profile.avatar_url }}" alt="{{ profile.display_name or 'Author' }}">
            {% else %}
              <span>{{ (profile.display_name[:1] if profile and profile.display_name else session.get('user','A')[:1]) }}</span>
            {% endif %}
          </div>
          <div class="who">
            <div class="name">{{ profile.display_name if profile and profile.display_name else session.get('user','Author') }}</div>
            <div class="times">
              <span>Published on: {{ article.published_at }}</span>
              <span>Updated on: {{ article.updated_at }}</span>
            </div>
          </div>
        </div>
      </article>

      <!-- Comments -->
      <section class="card comments">
        <div class="comments-title">Comments</div>

        {% for c in comments %}
        <div class="comment" id="c-{{ c.id }}">
          <div class="c-avatar">{{ c.initial }}</div>
          <div class="c-body">
            <div class="c-top">
              <span class="c-name">{{ c.user }}</span>
              <span class="c-time">{{ c.time }}</span>
            </div>
            <div class="c-text">{{ c.text }}</div>

            {% if c.replies and c.replies|length %}
            <div class="replies">
              {% for r in c.replies %}
              <div class="reply">
                <div class="r-meta">{{ r.by }} â€¢ {{ r.time }}</div>
                <div class="r-text">{{ r.text }}</div>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <form class="reply-row" method="post" action="{{ url_for('author_article2_reply') }}">
              <input type="hidden" name="comment_id" value="{{ c.id }}">
              <input type="text" name="reply" placeholder="reply comment.." required>
              <button class="btn btn-light" type="submit">send</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </section>
    </section>

    <!-- RIGHT -->
    <aside class="sidebar">
      <a href="{{ url_for('create_edit_delete_article') }}" class="btn btn-primary wide">Create Your Story</a>
      <div class="ads">Ads</div>
    </aside>
  </main>

  <!-- Logout modal -->
  <div id="logoutModal" class="modal-overlay">
    <div class="modal"><h2>Log Out?</h2><div class="buttons"><button class="yes" id="confirmLogout">Yes</button><button class="no" id="cancelLogout">No</button></div></div>
  </div>

  <script>
    (function(){
      // header menu
      const btn=document.getElementById('menuBtn'), panel=document.getElementById('menuPanel');
      if(btn&&panel){const close=()=>panel.style.display='none', toggle=()=>panel.style.display=panel.style.display==='block'?'none':'block';
        btn.addEventListener('click',e=>{e.stopPropagation();toggle()});
        document.addEventListener('click',e=>{if(!panel.contains(e.target)&&e.target!==btn)close()});
        document.addEventListener('keydown',e=>{if(e.key==='Escape')close()});
      }

      // kebab
      const kBtn = document.getElementById('articleMenuBtn');
      const kPanel = document.getElementById('articleMenuPanel');
      if(kBtn && kPanel){
        const kClose = ()=> kPanel.style.display='none';
        const kToggle = ()=> kPanel.style.display = (kPanel.style.display==='block') ? 'none' : 'block';
        kBtn.addEventListener('click', e => { e.stopPropagation(); kToggle(); });
        document.addEventListener('click', e => { if(!kPanel.contains(e.target) && e.target !== kBtn) kClose(); });
        document.addEventListener('keydown', e => { if(e.key==='Escape') kClose(); });
      }

      // logout
      const modal=document.getElementById("logoutModal"), ok=document.getElementById("confirmLogout"), no=document.getElementById("cancelLogout");
      document.querySelectorAll(".logout-link").forEach(l=>{l.addEventListener("click",e=>{e.preventDefault();modal.style.display="flex"})});
      ok&&ok.addEventListener("click",()=>{window.location.href="{{ url_for('logout') }}"});
      no&&no.addEventListener("click",()=>{modal.style.display="none"});
      document.addEventListener("keydown",e=>{if(e.key==="Escape")modal.style.display="none"});
    })();
  </script>
</body>
</html>
