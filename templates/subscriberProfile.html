<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Profile â€” EchoPress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('static', filename='img/echopresslogo.png') }}" type="image/png" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subscriber.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

  <!-- Top Bar (optional: keep consistent with your site) -->
  <header class="topbar">
    <div class="left">
      <button type="button" class="brand" onclick="window.location.href='{{ url_for('subscriberHomepage') }}'">
        <img src="{{ url_for('static', filename='img/echopresslogo.png') }}" alt="EchoPress" height="28">
      </button>
    </div>
    <div class="right">
      <span class="welcome">Welcome, {{ session.get('user','Subscriber') }} !</span>
      <button id="menuBtn" class="burger" aria-label="Menu"><span></span><span></span><span></span></button>
      <div id="menuPanel" class="menu-panel">
        <a class="menu-item" href="{{ url_for('subscriber_my_articles') }}">View My Articles</a>
        <a class="menu-item" href="{{ url_for('subscriber_bookmarks') }}">View Bookmark</a>
        <a class="menu-item" href="{{ url_for('subscriber_analytics') }}">View Analytics</a>
        <a class="menu-item" href="{{ url_for('profile') }}">My Profile</a>
        <a class="menu-item logout-link" href="{{ url_for('logout') }}">Log Out</a>
      </div>
    </div>
  </header>

  <main class="page">
    <!-- Main column -->
    <section class="feed">
      <div class="article-card detail">
        <div class="card-header">Edit Profile</div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="alerts">
              {% for category, msg in messages %}
                <div class="alert {{ category }}">{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <form class="create-form" action="{{ url_for('profile_update') }}" method="post" enctype="multipart/form-data">
          <input type="hidden" id="nextField" name="next" value="{{ request.referrer or url_for('profile') }}">

          <div class="form-grid">
            <!-- Avatar -->
            <label>Current avatar</label>
              <div class="avatar">
                {% set raw_name = (user.name if user is defined else profile.display_name) or 'User' %}
                {% set initial = raw_name[0]|upper %}
                {% set current_img = (user.image if user is defined else profile.avatar_url) or '' %}
                {% set show_img = current_img.replace('../static','/static').replace('./static','/static') if current_img else '' %}

                {% if show_img %}
                  <img id="avatarPreview" src="{{ show_img }}" alt="Profile picture">
                {% else %}
                  <div id="avatarPreview" class="avatar-initial" aria-label="Avatar">{{ initial }}</div>
                {% endif %}
              </div>


            <!-- Name (editable) -->
            <label for="name">Name</label>
            <input id="name" name="name" type="text" value="{{ (user.name if user is defined else profile.display_name) or '' }}" required>

            <!-- Email (locked) -->
            <label for="email">Email</label>
            <input id="email" type="email" value="{{ (user.email if user is defined else profile.email) or '' }}" readonly disabled>

            <!-- Role (locked) -->
            <label for="usertype">Role</label>
            <input id="usertype" type="text" value="{{ (user.usertype if user is defined else profile.usertype) or '' }}" readonly disabled>

            <!-- Bio (editable) -->
            <label for="bio">Bio</label>
            <textarea id="bio" name="bio" rows="5">{{ (user.bio if user is defined else profile.bio) or "" }}</textarea>

            <!-- Avatar upload -->
            <label for="avatar">Upload new avatar</label>
            <input id="avatar" name="avatar" type="file" accept="image/*">
          </div>

          <div class="form-buttons">
            <button type="button" class="btn btn-light" id="btnCancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>

        <div id="profileToast" class="toast" role="status" aria-live="polite"></div>

    </section>

    <!-- Right sidebar -->
    <aside class="sidebar">
      <a href="{{ url_for('subscriberCreateArticle') }}" class="btn btn-primary">Create Your Story</a>
      <div class="ads" id="adsBox" aria-live="polite"></div>
    </aside>
  </main>

      <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h2>Log out?</h2>
      <div class="buttons">
        <button type="button" class="btn btn-light" id="logoutCancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="logoutConfirm">Proceed</button>
      </div>
    </div>
  </div>

  <!-- Minimal JS: live preview for avatar -->
    <script>
      (function () {
        // Keep "next" accurate
        const nextField = document.getElementById('nextField');
        if (document.referrer && nextField && !nextField.value) nextField.value = document.referrer;

        // Cancel -> back to last page (fallback)
        const cancel = document.getElementById('btnCancel');
        if (cancel) cancel.addEventListener('click', function () {
          if (document.referrer) history.back();
          else window.location.href = "{{ url_for('subscriberHomepage') }}";
        });

        // Live avatar preview
        const input = document.getElementById('avatar');
        const preview = document.getElementById('avatarPreview');
        if (input && preview) {
          input.addEventListener('change', function (e) {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
              if (preview.tagName === 'IMG') {
                preview.src = ev.target.result;
              } else {
                const img = document.createElement('img');
                img.id = 'avatarPreview';
                img.src = ev.target.result;
                img.className = preview.className;
                preview.replaceWith(img);
              }
            };
            r.readAsDataURL(f);
          });
        }

        // ðŸ”’ Client-side required fields check before submit
        const form = document.querySelector('form.create-form');
        const nameInput = document.getElementById('name');
        const bioInput  = document.getElementById('bio');
        const toast = document.getElementById('profileToast');

        function showToast(msg, ms=2000) {
          if (!toast) return;
          toast.textContent = msg;
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), ms);
        }

        if (form && nameInput && bioInput) {
          form.addEventListener('submit', function (e) {
            const name = (nameInput.value || '').trim();
            const bio  = (bioInput.value  || '').trim();
            if (!name || !bio) {
              e.preventDefault(); // donâ€™t submit
              showToast('Name and Bio are required.');
              if (!name) nameInput.focus();
              else bioInput.focus();
            }
          });
        }

        // Toast on redirect query flags (?updated=1 | ?error=1&msg=... | ?nochange=1), then go back after 2s
        const params   = new URLSearchParams(location.search);
        const updated  = params.get('updated') === '1';
        const isError  = params.get('error') === '1';
        const nochange = params.get('nochange') === '1';
        const msg      = params.get('msg') || '';
        const next     = params.get('next');

        if (updated || isError || nochange) {
          if (isError)       showToast(msg ? `Error updating profile: ${msg}` : 'Error updating profile. Please try again.');
          else if (nochange) showToast('No changes â€” redirecting backâ€¦');
          else               showToast('Profile updated');

          setTimeout(() => { if (next) location.href = next; }, 2000);
        }
      })();
      </script>

       <!-- Menu toggle -->
  <script>
    (function(){
      const btn = document.getElementById('menuBtn');
      const panel = document.getElementById('menuPanel');
      if(!btn || !panel) return;
      const closeP  = () => panel.style.display='none';
      const toggleP = () => panel.style.display = panel.style.display==='block' ? 'none' : 'block';
      btn.addEventListener('click', e => { e.stopPropagation(); toggleP(); });
      document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) closeP(); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeP(); });
    })();
  </script>
      
      <!-- Ads Box Functions -->
  <script>
  (function(){
    const adsBox   = document.getElementById('adsBox');
    const ADS_API  = "{{ url_for('api_random_ad') }}";
    const esc = s => (s||"").replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

    function renderAd(ad){
      if(!adsBox) return;
      adsBox.innerHTML = `
        <a class="ad-link" href="${esc(ad.website)}" target="_blank" rel="noopener">
          <img class="ad-image" src="${esc(ad.image)}" alt="${esc(ad.title || 'Advertisement')}">
          ${ad.title ? `<h4 class="ad-title">${esc(ad.title)}</h4>` : ``}
          ${ad.desc  ? `<p class="ad-desc">${esc(ad.desc)}</p>`   : ``}
        </a>
      `;
    }

    async function loadAd(){
      try{
        const res = await fetch(ADS_API, {cache:'no-store'});
        if(!res.ok) return;
        const data = await res.json();
        if(data?.ok && data.ad) renderAd(data.ad);
      }catch(_){}
    }

    loadAd();
    setInterval(loadAd, 10_000); // your 10s rotation
  })();
  </script>

  <!-- Logout modal wiring (AFTER modal element) -->
  <script>
    (function () {
      const modal   = document.getElementById('logoutModal');
      const confirm = document.getElementById('logoutConfirm');
      const cancel  = document.getElementById('logoutCancel');

      document.querySelectorAll('.logout-link').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          modal.dataset.href = a.getAttribute('href');
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
        });
      });

      function closeModal() {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        delete modal.dataset.href;
      }

      if (cancel)  cancel.addEventListener('click', closeModal);
      if (confirm) confirm.addEventListener('click', () => {
        const href = modal.dataset.href || "{{ url_for('logout') }}";
        window.location.href = href;
      });

      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('show')) closeModal();
      });
    })();

    // Fix back/forward cache so the page refreshes correctly
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
        window.location.reload();
      }
    });
  </script>
  {% include 'partials/chatbot.html' %}
</body>
</html>
