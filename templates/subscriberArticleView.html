<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ article.title }} — EchoPress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" type="image/png" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subscriber.css') }}">
</head>
<body>

  <!-- Top Bar -->
  <header class="topbar">
    <div class="left">
      <!-- Back to subscriber home -->
      <button type="button" class="brand" onclick="window.location.href='{{ url_for('subscriberHomepage') }}'">
        <img src="{{ url_for('static', filename='img/echopresslogo.png') }}" alt="EchoPress" />
      </button>

      <!-- (Optional) public search; leave as-is if you want it -->
      <form class="search" action="{{ url_for('search') }}" method="get" role="search">
        <input type="text" name="q" placeholder="Searching for… ?" aria-label="Search" />
        <button type="submit" aria-label="Search">Search</button>
      </form>
    </div>

    <div class="right">
      <span class="welcome">Welcome, {{ session.get('user','Subscriber') }} !</span>
      <button id="menuBtn" class="burger" aria-label="Menu"><span></span><span></span><span></span></button>
      <div id="menuPanel" class="menu-panel">
        <a class="menu-item" href="{{ url_for('subscriber_my_articles') }}">View My Articles</a>
        <a class="menu-item" href="{{ url_for('subscriber_bookmarks') }}">View Bookmark</a>
        <span class="menu-item">View Analytics</span>
        <span class="menu-item">Edit Profile</span>
        <a class="menu-item" href="{{ url_for('logout') }}">Log Out</a>
      </div>
    </div>
  </header>

  <!-- Page -->
  <main class="page">
    <section class="feed">
      <article class="article-card detail article-view">
        <header class="article-header">
          <h1 class="article-title">{{ article.title }}</h1>

          <!-- Actions stack: Pin/Unpin, then Read Aloud -->
          <div class="article-actions" style="display:flex; flex-direction:column; gap:.5rem; align-items:flex-start;">
            <button id="pinBtn" class="pin-btn" aria-pressed="{{ 'true' if is_pinned else 'false' }}">
              <span class="pin-icon" aria-hidden="true">📌</span>
              <span class="pin-text">{{ 'Unpin' if is_pinned else 'Pin' }}</span>
            </button>

            <!-- NEW: Read Aloud button -->
            <button id="readBtn" class="btn btn-light" type="button" aria-live="polite">
              🔊 Read Article
            </button>
          </div>
        </header>

        <!-- Two-column body: text + image (image stacks on mobile via CSS) -->
        <div class="article-body two-col">
          <div class="article-content">
            {{ article.content | safe }}
          </div>

          {% if article.image %}
            <div class="thumb-wrap side">
              <img src="{{ article.image }}" alt="Article image">
            </div>
          {% endif %}
        </div>

        <div class="meta">
          <span><strong>{{ article.author or 'EchoPress' }}</strong></span>
          {% if article.category %}<span>• {{ article.category }}</span>{% endif %}
          {% if article.published_at %}<span>• Published {{ article.published_at }}</span>{% endif %}
          {% if article.updated_at %}<span>• Updated {{ article.updated_at }}</span>{% endif %}
        </div>
      </article>

      <!-- Comments placeholder (no persistence yet) -->
      <section class="card" style="padding:18px; margin-top:16px;">
        <h3 style="margin:0 0 12px 0;">Comments</h3>
        <p style="color:#666">Comments feature coming soon.</p>
      </section>
    </section>

    <aside class="sidebar">
      <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url_for('subscriberCreateArticle') }}'">Create Your Story</button>
      <div class="ads">Ads</div>
    </aside>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <span id="toastMsg">Done.</span>
  </div>

  <!-- Topbar menu toggle -->
  <script>
    (function(){
      const btn = document.getElementById('menuBtn');
      const panel = document.getElementById('menuPanel');
      if (!btn || !panel) return;
      const closeP  = () => panel.style.display = 'none';
      const toggleP = () => panel.style.display = panel.style.display==='block' ? 'none' : 'block';
      btn.addEventListener('click', e => { e.stopPropagation(); toggleP(); });
      document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) closeP(); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeP(); });
    })();
  </script>

  <!-- Pin/Unpin -->
  <script>
    (function(){
      const pinBtn  = document.getElementById('pinBtn');
      const toast   = document.getElementById('toast');
      const msgEl   = document.getElementById('toastMsg');
      const showToast = (m) => { msgEl.textContent = m || 'Done.'; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1400); };

      if (!pinBtn) return;

      pinBtn.addEventListener('click', async () => {
        try{
          const res = await fetch("{{ url_for('subscriber_toggle_pin') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ articleID: {{ article.articleID }} })
          });
          const data = await res.json();
          if (!res.ok || !data.ok) throw new Error(data.message || "Failed");

          const nowPinned = data.state === 'pinned';
          pinBtn.setAttribute('aria-pressed', nowPinned ? 'true' : 'false');
          pinBtn.querySelector('.pin-text').textContent = nowPinned ? 'Unpin' : 'Pin';
          showToast(nowPinned ? 'Pinned to your list.' : 'Unpinned.');
        }catch(err){
          showToast('Unable to update pin. Please try again.');
        }
      });
    })();
  </script>

  <!-- Text-to-Speech -->
  <script>
    (function(){
      const readBtn = document.getElementById('readBtn');
      const toast   = document.getElementById('toast');
      const msgEl   = document.getElementById('toastMsg');
      const showToast = (m) => { msgEl.textContent = m || 'Done.'; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1400); };

      if (!readBtn) return;

      // Basic state machine
      let state = 'idle'; // 'idle' | 'reading' | 'paused'
      let queue = [];     // utterances queue

      function getArticleText() {
        const el = document.querySelector('.article-content');
        if (!el) return '';
        // Prefer visible text only
        return el.innerText.replace(/\s+\n/g, '\n').trim();
      }

      function splitIntoChunks(text, maxLen = 1800) {
        // Split by paragraphs and sentences to keep utterances natural and under limits
        const parts = [];
        const paras = text.split(/\n{2,}/);
        for (const p of paras) {
          const clean = p.replace(/\s+/g,' ').trim();
          if (!clean) continue;
          if (clean.length <= maxLen) { parts.push(clean); continue; }
          // Further split by sentence-ish boundaries
          const sentences = clean.split(/([.!?…]+)\s+/);
          let buf = '';
          for (let i=0; i<sentences.length; i+=2) {
            const chunk = (sentences[i] || '') + (sentences[i+1] || '');
            if ((buf + ' ' + chunk).trim().length > maxLen) {
              if (buf) parts.push(buf.trim());
              buf = chunk;
            } else {
              buf = (buf ? (buf + ' ' + chunk) : chunk);
            }
          }
          if (buf) parts.push(buf.trim());
        }
        return parts;
      }

      function resetSpeech() {
        window.speechSynthesis.cancel();
        state = 'idle';
        queue = [];
        readBtn.textContent = '🔊 Read Article';
      }

      function speak() {
        const text = getArticleText();
        if (!text) { showToast('Nothing to read.'); return; }

        // Prepare utterances
        const chunks = splitIntoChunks(text);
        queue = chunks.map(t => {
          const u = new SpeechSynthesisUtterance(t);
          // Optional: tweak rate/pitch if you like
          u.rate = 1.0;   // 0.1–10
          u.pitch = 1.0;  // 0–2
          u.onend = handleUtteranceEnd;
          u.onerror = (e) => { console.error(e); resetSpeech(); showToast('Reading error.'); };
          return u;
        });

        // Start speaking
        state = 'reading';
        readBtn.textContent = '⏸️ Pause';
        queue.forEach(u => window.speechSynthesis.speak(u));
      }

      function handleUtteranceEnd() {
        // When the last utterance completes, if nothing left in the queue AND not paused, return to idle
        const speaking = window.speechSynthesis.speaking;
        const pending  = window.speechSynthesis.pending;
        if (!speaking && !pending && state !== 'paused') {
          resetSpeech();
        }
      }

      function toggle() {
        if (!('speechSynthesis' in window)) {
          showToast('Text reading is not supported on this browser.');
          return;
        }

        if (state === 'idle') {
          // Fresh read
          speak();
        } else if (state === 'reading') {
          // Pause
          window.speechSynthesis.pause();
          state = 'paused';
          readBtn.textContent = '▶️ Resume';
        } else if (state === 'paused') {
          // Resume
          window.speechSynthesis.resume();
          state = 'reading';
          readBtn.textContent = '⏸️ Pause';
        }
      }

      // Stop reading if the user navigates away or reloads
      window.addEventListener('beforeunload', resetSpeech);
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && state === 'reading') {
          // Auto-pause when tab hidden
          window.speechSynthesis.pause();
          state = 'paused';
          readBtn.textContent = '▶️ Resume';
        }
      });

      readBtn.addEventListener('click', toggle);
    })();
  </script>
</body>
</html>
