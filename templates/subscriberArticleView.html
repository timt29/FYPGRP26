<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ article.title }} - EchoPress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('static', filename='img/EchoPressLogo.png') }}" type="image/png" />

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subscriber.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility_toolbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

  <!-- Top Bar  -->
  <header class="topbar">
    <div class="left">
      <button type="button" class="brand" onclick="window.location.href='{{ url_for('subscriberHomepage') }}'">
        <img src="{{ url_for('static', filename='img/EchoPressLogo.png') }}" alt="EchoPress" height="28">
      </button>
    </div>
    <div class="right">
      {% set role =
          (user.usertype if (user is defined and user.usertype) else session.get('usertype','')) | trim | lower %}
      {% set is_author = (role == 'author') %}

      <!-- Notification bell -->
      <button id="notifBtn" class="bell" aria-label="Notifications">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="M12 22a2.5 2.5 0 0 0 2.45-2h-4.9A2.5 2.5 0 0 0 12 22zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <span id="notifBadge" class="badge hidden" aria-hidden="true">0</span>
      </button>

      <div id="notifPanel" class="notif-panel" role="dialog" aria-label="Notifications" aria-hidden="true">
        <div class="notif-head">
          <strong>Notifications</strong>
          <button id="notifMarkAll" class="btn btn-light sm" type="button">Mark all as read</button>
        </div>
        <ul id="notifList" class="notif-list" role="list"></ul>
        <div class="notif-empty hidden">No new notifications</div>
      </div>

      <span class="welcome">
        Welcome, {{ session.get('user','Subscriber') }}
        {% if is_author %}
          <img
            class="badge-author"
            src="{{ url_for('static', filename='img/AuthorVerifiedLogo.png') }}"
            alt="Author verified"
            width="18" height="18"
            decoding="async" loading="eager"
            style="display:inline-block; vertical-align:middle;"
          >
        {% endif %}
      </span>

      <button id="menuBtn" class="burger" aria-label="Menu"><span></span><span></span><span></span></button>
      <div id="menuPanel" class="menu-panel">
        <a class="menu-item" href="{{ url_for('subscriber_my_articles') }}">View My Articles</a>
        <a class="menu-item" href="{{ url_for('subscriber_bookmarks') }}">View Bookmark</a>
        <a class="menu-item" href="{{ url_for('subscriber_analytics') }}">View Analytics</a>
        <a class="menu-item" href="{{ url_for('profile') }}">My Profile</a>
        <a class="menu-item" href="{{ url_for('donate_form') }}">Donate to EchoPress</a>
        <a class="menu-item logout-link" href="{{ url_for('logout') }}">Log Out</a>
      </div>
    </div>
  </header>

  <!-- Page -->
  <main class="page">

    <!-- ===== ARTICLE VIEW ===== -->
    <section id="articleSection" class="feed">
      <article id="articleRoot" class="article-card detail article-view" data-article-id="{{ article.articleid }}">
        <header class="article-header">
          <h1 class="article-title">{{ article.title }}</h1>
        </header>

        {% include 'partials/accessibility_toolbar.html' %}

        <!-- RIGHT-ALIGNED ACTION BAR -->
        <div class="action-bar">
          <button id="bookmarkBtn" class="btn btn-ghost" aria-pressed="{{ 'true' if is_pinned else 'false' }}">
            <span class="pin-icon" aria-hidden="true">üìå</span>
            <span class="label">{{ 'Remove Bookmark' if is_pinned else 'Add Bookmark' }}</span>
          </button>

          <div id="ttsWrap">
            <button id="ttsStart" class="btn btn-ghost">
              <span aria-hidden="true">üîä</span> Read Article
            </button>
            <div id="ttsControls" class="tts-controls hidden">
              <button id="ttsPause"  class="btn btn-ghost">Pause</button>
              <button id="ttsResume" class="btn btn-ghost">Continue</button>
              <button id="ttsReplay" class="btn btn-ghost">Replay</button>

              <label>Speaker:
                <select id="ttsGender">
                  <option value="auto" selected>Auto</option>
                  <option value="female">Female</option>
                  <option value="male">Male</option>
                </select>
              </label>

              <label>Speed:
                <select id="ttsRate">
                  <option value="0.5">0.5√ó</option>
                  <option value="1" selected>1√ó</option>
                  <option value="2">2√ó</option>
                </select>
              </label>
            </div>
          </div>
        </div>

        <!-- Translate -->
        <div style="margin: 15px 20px;">
          <label for="language">Translate to:</label>
          <select id="language" onchange="translateArticle()">
            <option value="en">English (Default)</option>
            <optgroup label="Asian Languages">
              <option value="zh-CN">Chinese (Simplified)</option>
              <option value="ms">Malay</option>
              <option value="ko">Korean</option>
              <option value="ja">Japanese</option>
              <option value="vi">Vietnamese</option>
            </optgroup>
            <optgroup label="European Languages">
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="nl">Dutch</option>
              <option value="ru">Russian</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
            </optgroup>
          </select>
        </div>

        {% if article.image %}
          <figure class="article-hero">
            <img src="{{ article.image }}" alt="{{ article.title }}">
            {% if article.image_credit %}
              <figcaption class="article-hero-cap">{{ article.image_credit }}</figcaption>
            {% endif %}
          </figure>
        {% endif %}

        {% if summary_points %}
        <div class="summary-box">
          <h3>Summary</h3>
          <ul id="summaryList">
            {% for point in summary_points %}
              <li>{{ point | safe }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

       
          <div class="article-content">
            {{ article.content | safe }}
          </div>
          
        <div class="meta-row">
          {% set profile_href = url_for('subscriber_profile_view', user_id=article.author_userid or 0) %}

          <div class="author-left">
            <a class="author-link" href="{{ profile_href }}" aria-label="{{ article.author }}'s profile">
              {% if article.author_image %}
                <img class="author-avatar" src="{{ article.author_image }}" alt="{{ article.author }} avatar">
              {% else %}
                {% set parts = (article.author or 'U').split() %}
                <div class="author-avatar initials" aria-hidden="true">
                  {{ (parts[0][0] ~ (parts[1][0] if parts|length>1 else ''))|upper }}
                </div>
              {% endif %}
            </a>

            <div class="author-text">
              <div class="author-line">
              <a class="author-link author-name" href="{{ profile_href }}">
                <span class="author-name-text">{{ article.author or 'EchoPress' }}</span>
              </a>

              {# Show the badge only if this article‚Äôs author role is Author #}
              {% set author_is_author = (article.author_usertype|default('')|lower == 'author') %}
              {% if author_is_author %}
                <img
                  class="author-verified-badge"
                  src="{{ url_for('static', filename='img/AuthorVerifiedLogo.png') }}"
                  alt="Author verified"
                  width="16" height="16"
                  decoding="async" loading="eager">
              {% endif %}

              {% if article.category %}
                <span class="dot">‚Ä¢</span><span class="author-tag">{{ article.category }}</span>
              {% endif %}
            </div>

              <div class="author-meta">
                {% if article.published_at %}<span class="dot"> ‚Ä¢ Published On : {{ article.published_at | dmyhm }}</span>{% endif %}
                {% if article.updated_at %}<span class="dot"> ‚Ä¢ Updated On : {{ article.updated_at | dmyhm }}</span>{% endif %}
              </div>
            </div>
          </div>

        <div class="reaction-bar">
          <button id="articleLikeBtn" class="btn btn-ghost react" data-action="like" aria-pressed="false">
            üëç <span id="artLikeCount">{{ article.likes or 0 }}</span>
          </button>
          <button id="articleDislikeBtn" class="btn btn-ghost react" data-action="dislike" aria-pressed="false">
            üëé <span id="artDislikeCount">{{ article.dislikes or 0 }}</span>
          </button>
        </div>
        
        <div class="action-buttons">
          <button id="articleReportBtn" class="btn btn-ghost" title="Report">
            <img src="{{ url_for('static', filename='img/report.jpg') }}" alt="Report" style="width:20px; vertical-align:middle;" />
            <span>Report</span>
          </button>

          <button id="shareBtn" class="btn btn-ghost" title="Share">
            <img src="{{ url_for('static', filename='img/share.png') }}" alt="Share" style="width:20px; vertical-align:middle;" />
            <span>Share</span>
          </button>
        </div>
      </article>

      <!-- Comments -->
      <section id="comments" class="section">
        <form id="cForm" class="comment-form">
          <textarea id="cInput" class="comment-input" placeholder="Add a comment here."></textarea>
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
        <div id="cList" class="comment-list" style="margin-top:12px;"></div>
      </section>
    </section>

    <!-- ===== SEARCH RESULTS ===== -->
    <section id="resultsSection" class="feed hidden" aria-live="polite" aria-busy="false">
      <div class="results-header">
        <h2 class="results-title">Search results</h2>
        <button id="closeResults" type="button" class="btn btn-light">Close results</button>
      </div>
      <section id="resultsFeed"></section>
    </section>

    <aside class="sidebar">
      <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url_for('subscriberCreateArticle') }}'">
        Create Your Story
      </button>
      <button type="button"
              class="btn btn-primary"
              onclick="window.location.href='{{ url_for('donate_form') }}'">
        Donate to EchoPress
      </button>
      <div class="ads" id="adsBox" aria-live="polite"></div>
    </aside>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <span id="toastMsg">Done.</span>
  </div>

  <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h2>Log out?</h2>
      <div class="buttons">
        <button type="button" class="btn btn-light" id="logoutCancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="logoutConfirm">Proceed</button>
      </div>
    </div>
  </div>
  <div id="logoutSuccess" class="toast" role="status" aria-live="polite" aria-atomic="true" style="display:none;">
  <span>Logged out successfully.</span>
  </div>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo" aria-label="Site footer">
    <div class="footer-container">
      <div class="footer-top">
        <a class="footer-brand" href="{{ url_for('subscriberHomepage') }}">EchoPress</a>
        <nav class="footer-links" aria-label="Key links">
          <ul>
            <li><a href="{{ url_for('subscriber_my_articles') }}">My Articles</a></li>
            <li><a href="{{ url_for('subscriber_bookmarks') }}">Bookmarks</a></li>
            <li><a href="{{ url_for('profile') }}">My Profile</a></li>
            <li><a href="{{ url_for('subscriberCreateArticle') }}">Create Story</a></li>
            <li><a href="{{ url_for('donate_form') }}">Donate</a></li>
          </ul>
        </nav>
      </div>

      <div class="footer-grid">
        <div class="footer-support">
          <h3>Support EchoPress</h3>
          <p>Your contribution keeps independent journalism alive.</p>
          <a class="btn btn-primary" href="{{ url_for('donate_form') }}">Donate</a>
          <ul class="footer-social" aria-label="Social links">
            <li><a href="https://facebook.com/" target="_blank" rel="noopener">
              <img src="{{ url_for('static', filename='img/facebook.png') }}" alt="Facebook"></a></li>
            <li><a href="https://x.com/" target="_blank" rel="noopener">
              <img src="{{ url_for('static', filename='img/x.png') }}" alt="X"></a></li>
            <li><a href="https://instagram.com/" target="_blank" rel="noopener">
              <img src="{{ url_for('static', filename='img/instagram.png') }}" alt="Instagram"></a></li>
            <li><a href="https://www.linkedin.com/" target="_blank" rel="noopener">
              <img src="{{ url_for('static', filename='img/linkedin.png') }}" alt="LinkedIn"></a></li>
          </ul>
        </div>
      </div>

      <div class="footer-legal">
        <address class="footer-contact">
          Newsroom: <a href="mailto:newsdesk@echopress.com">Email Us</a> ¬∑
          Ads: <a href="mailto:ads@echopress.com">Email Us</a> ¬∑
        </address>
        <p class="footer-copy">¬© <span id="footer-year"></span> EchoPress. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- ===== Shared Report Modal (single) ===== -->
  <div id="reportOverlay" class="report-modal-overlay" aria-hidden="true">
    <div class="report-modal-card" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
      <h3 id="reportTitle" class="report-modal-title">Report</h3>

      <div class="report-modal-body">
        <label for="reportReason">Reason:</label>
        <select id="reportReason">
          <option value="">-- Select a reason --</option>
          <option value="spam">Spam</option>
          <option value="inappropriate">Inappropriate</option>
          <option value="harassment">Harassment</option>
          <option value="other">Other</option>
        </select>

        <label for="reportNote">Additional details (optional):</label>
        <textarea id="reportNote" rows="4" placeholder="Describe the issue‚Ä¶"></textarea>
      </div>

      <div class="report-modal-actions">
        <button type="button" id="reportCancel" class="btn btn-light">Cancel</button>
        <button type="button" id="reportSubmit" class="btn btn-primary">Submit Report</button>
      </div>
    </div>
  </div>

  <!-- ===== Scripts ===== -->

  <!-- Topbar menu toggle -->
  <script>
    (function(){
      const btn = document.getElementById('menuBtn');
      const panel = document.getElementById('menuPanel');
      if (!btn || !panel) return;
      const closeP  = () => panel.style.display = 'none';
      const toggleP = () => panel.style.display = panel.style.display==='block' ? 'none' : 'block';
      btn.addEventListener('click', e => { e.stopPropagation(); toggleP(); });
      document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) closeP(); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeP(); });
    })();
  </script>

  <!-- In-page Subscriber Search -->
  <script>
    (function(){
      const API_URL      = "{{ url_for('subscriber_search_api') }}";
      const VIEW_URL_TPL = "{{ url_for('subscriber_article_view', article_id=0) }}";
      const PLACEHOLDER  = "{{ url_for('static', filename='img/placeholder.png') }}";

      const form   = document.getElementById('subSearchForm');
      const input  = document.getElementById('subSearchQ');
      const articleSection = document.getElementById('articleSection');
      const resultsSection = document.getElementById('resultsSection');
      const resultsFeed    = document.getElementById('resultsFeed');
      const closeBtn       = document.getElementById('closeResults');

      const esc = s => (s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      const trunc = (t, n=220) => (!t ? "" : (t=t.trim(), t.length>n ? t.slice(0,n-1)+"‚Ä¶" : t));

      function imageCandidates(raw) {
        let v = (raw ?? "").toString().trim();
        const downs = v.toLowerCase();
        if (!v || downs === "null" || downs === "none" || downs === "undefined") return [];
        const fname = v.split("/").pop();
        const list = [];
        if (/^https?:\/\//i.test(v)) list.push(v);
        if (/static\//i.test(v)) list.push(v.startsWith("/") ? v : "/" + v);
        if (!/^https?:\/\//i.test(v) && /\/./.test(v)) {
          list.push(v.startsWith("/") ? v : "/" + v);
          list.push("/static/" + v.replace(/^\/+/, ""));
        }
        if (fname && !v.includes("/")) {
          list.push("/static/uploads/" + fname);
          list.push("/static/img/" + fname);
        }
        return [...new Set(list)];
      }

      function attachImageLoader(img, candidates) {
        if (!candidates.length) { img.src = PLACEHOLDER; return; }
        let idx = 0;
        function tryNext() {
          if (idx >= candidates.length) { img.src = PLACEHOLDER; return; }
          img.src = candidates[idx++];
        }
        img.onerror = tryNext;
        tryNext();
      }

      function card(a){
        const rawImage = a.image ?? a.image_url ?? a.imagePath ?? a.imageName ?? a.cover;
        const cands = imageCandidates(rawImage);
        const id = `img_${a.articleid}_${Math.random().toString(36).slice(2)}`;

        const html = `
          <article class="article-card open-article" data-id="${a.articleid}" role="button" tabindex="0">
            <div class="text">
              <h3>${esc(a.title)}</h3>
              <p class="desc">${esc(trunc(a.content))}</p>
            </div>
            <div class="thumb-wrap"><img id="${id}" alt=""></div>
          </article>`;
        queueMicrotask(() => {
          const img = document.getElementById(id);
          if (img) attachImageLoader(img, cands);
        });
        return html;
      }

      async function runSearch(q){
        resultsSection.setAttribute('aria-busy','true');
        resultsFeed.innerHTML = "";
        try{
          const p = new URLSearchParams({ q, limit: "20" });
          const res = await fetch(`${API_URL}?${p.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const rows = await res.json();
          resultsFeed.innerHTML = rows.length ? rows.map(card).join("") : "<p>No articles found.</p>";
        }catch(err){
          console.error(err);
          resultsFeed.innerHTML = `<p style="color:#b00">Failed to load results.</p>`;
        }finally{
          resultsSection.setAttribute('aria-busy','false');
        }
      }

      function showResults(){ articleSection.classList.add('hidden'); resultsSection.classList.remove('hidden'); }
      function hideResults(){ resultsSection.classList.add('hidden'); articleSection.classList.remove('hidden'); }

      if (form){
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const q = (input.value || '').trim();
          if (!q) { hideResults(); return; }
          showResults();
          runSearch(q);
        });
      }
      if (closeBtn) closeBtn.addEventListener('click', hideResults);
      if (input) input.addEventListener('input', () => { if (input.value.trim()==="") hideResults(); });

      resultsFeed.addEventListener('click', (e) => {
        const el = e.target.closest('.open-article');
        if (!el) return;
        const url = VIEW_URL_TPL.replace(/0$/, el.dataset.id);
        window.location.href = url;
      });
      resultsFeed.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        const el = e.target.closest('.open-article');
        if (!el) return;
        const url = VIEW_URL_TPL.replace(/0$/, el.dataset.id);
        window.location.href = url;
      });
    })();
  </script>

  <!-- Bookmark + TTS -->
  <script>
    (function(){
      const toast   = document.getElementById('toast');
      const msgEl   = document.getElementById('toastMsg');
      const showToast = (m) => { msgEl.textContent = m || 'Done.'; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1400); };

      const bookmarkBtn = document.getElementById('bookmarkBtn');
      const articleRoot = document.getElementById('articleRoot');
      const articleid   = parseInt(articleRoot?.dataset.articleId || '0', 10);
      const endpoint    = "{{ url_for('subscriber_toggle_pin') }}";

      if (bookmarkBtn){
        bookmarkBtn.addEventListener('click', async () => {
          if (!articleid){ showToast('Missing article ID.'); return; }
          try{
            const res  = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ articleid })
            });
            const data = await res.json().catch(()=> ({}));
            if (!res.ok || !data.ok){ throw new Error(data.message || ('HTTP '+res.status)); }
            const nowBookmarked = data.state === 'pinned';
            bookmarkBtn.setAttribute('aria-pressed', nowBookmarked ? 'true' : 'false');
            const label = bookmarkBtn.querySelector('.label');
            if (label) label.textContent = nowBookmarked ? 'Remove Bookmark' : 'Add Bookmark';
            showToast(nowBookmarked ? 'Bookmarked.' : 'Removed from bookmarks.');
          }catch(err){
            showToast('Unable to update bookmark.');
            console.error(err);
          }
        });
      }

      // TTS controls (same as your working version)
      const ttsStart  = document.getElementById('ttsStart');
      const ttsCtrls  = document.getElementById('ttsControls');
      const ttsPause  = document.getElementById('ttsPause');
      const ttsResume = document.getElementById('ttsResume');
      const ttsReplay = document.getElementById('ttsReplay');
      const rateSel   = document.getElementById('ttsRate');
      const genderSel = document.getElementById('ttsGender');

      window.currentTTSLang = window.currentTTSLang || 'en';
      const mapLang = (code) => ({'en':'en-US','zh-CN':'zh-CN','ms':'ms-MY','ko':'ko-KR','ja':'ja-JP','vi':'vi-VN','es':'es-ES','fr':'fr-FR','de':'de-DE','nl':'nl-NL','ru':'ru-RU','it':'it-IT','pt':'pt-PT'})[code] || 'en-US';

      let allVoices = [];
      if ('speechSynthesis' in window){
        const load = () => allVoices = speechSynthesis.getVoices() || [];
        load(); speechSynthesis.onvoiceschanged = load;
      }
      const genderGuess = name => (/female|woman|feminine/i.test(name||'')) ? 'female' : (/male|man|masculine/i.test(name||'')) ? 'male' : 'unknown';
      function pickVoice(langCode, genderPref){
        if (!allVoices.length) return null;
        const want = mapLang(langCode).toLowerCase();
        const prefix = want.split('-')[0];
        let cands = allVoices.filter(v => (v.lang||'').toLowerCase() === want || (v.lang||'').toLowerCase().startsWith(prefix + '-'));
        if (genderPref !== 'auto'){
          const g = cands.filter(v => genderGuess(v.name) === genderPref);
          if (g.length) cands = g;
        }
        if (!cands.length) cands = allVoices.slice();
        const local = cands.filter(v => v.localService);
        return local[0] || cands[0] || null;
      }
      const getArticlePlainText = () => (document.querySelector('.article-content')?.innerText || '').trim();
      function splitIntoChunks(text, maxLen = 1000) {
        const parts = [];
        const paras = String(text || "").split(/\n{2,}/);
        for (let p of paras) {
          p = p.trim();
          if (!p) continue;
          if (p.length <= maxLen) { parts.push(p); continue; }
          const sentences = p.split(/(?<=[.!?„ÄÇÔºÅÔºü])\s+/);
          let buf = "";
          for (const s of sentences) {
            if ((buf + " " + s).trim().length <= maxLen) {
              buf = (buf ? buf + " " : "") + s;
            } else {
              if (buf) parts.push(buf);
              if (s.length <= maxLen) {
                buf = s;
              } else {
                let cur = "";
                for (const w of s.split(/\s+/)) {
                  if ((cur + " " + w).trim().length <= maxLen) cur = (cur ? cur + " " : "") + w;
                  else { if (cur) parts.push(cur); cur = w; }
                }
                if (cur) { parts.push(cur); buf = ""; }
              }
            }
          }
          if (buf) parts.push(buf);
        }
        return parts.length ? parts : [text];
      }

      let queue = [], idx = 0, currentUtter = null;
      function nextUtter(){
        if (idx >= queue.length) { currentUtter = null; return; }
        const utter = new SpeechSynthesisUtterance(queue[idx]);
        utter.lang  = mapLang(window.currentTTSLang);
        utter.rate  = Math.max(0.1, Math.min(3, parseFloat(rateSel?.value || '1') || 1));
        utter.pitch = 1.0;
        const v = pickVoice(window.currentTTSLang, (genderSel?.value || 'auto'));
        if (v) utter.voice = v;
        utter.onend = () => { idx++; nextUtter(); };
        utter.onerror = () => { idx++; nextUtter(); };
        currentUtter = utter;
        speechSynthesis.speak(utter);
      }
      function speakArticle(){
        if (!('speechSynthesis' in window)) { alert('Reader not supported by this browser.'); return; }
        speechSynthesis.cancel();
        queue = splitIntoChunks(getArticlePlainText(), 1000);
        idx = 0;
        if (!queue.length || !queue[0]) return;
        nextUtter();
      }
      ttsStart?.addEventListener('click', () => {
        const text = getArticlePlainText();
        if (!text) return alert('Nothing to read.');
        speakArticle();
        ttsCtrls.classList.remove('hidden');
        ttsStart.classList.add('hidden');
      });
      ttsPause?.addEventListener('click', () => {
        if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
      });
      ttsResume?.addEventListener('click', () => {
        if (speechSynthesis.paused) speechSynthesis.resume();
      });
      ttsReplay?.addEventListener('click', () => {
        speakArticle();
      });
      [rateSel, genderSel].forEach(sel => sel && sel.addEventListener('change', () => {
        if (speechSynthesis.speaking) speakArticle();
      }));
      window.addEventListener('beforeunload', () => { if ('speechSynthesis' in window) speechSynthesis.cancel(); });
    })();
  </script>

  <script>
    (function(){
      const articleRoot = document.getElementById('articleRoot');
      const articleid   = parseInt(articleRoot?.dataset.articleId || '0', 10);
      const likeBtn     = document.getElementById('articleLikeBtn');
      const dislikeBtn  = document.getElementById('articleDislikeBtn');
      const likeCountEl = document.getElementById('artLikeCount');
      const disCountEl  = document.getElementById('artDislikeCount');
      const endpoint    = "{{ url_for('subscriber_article_react') }}";

      async function react(action){
        if (!articleid) return;
        try{
          const res  = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ articleid, action })
          });
          const data = await res.json();
          if (!res.ok || !data.ok) throw new Error(data.message || ('HTTP '+res.status));
          if (likeCountEl) likeCountEl.textContent = data.likes;
          if (disCountEl)  disCountEl.textContent  = data.dislikes;
          likeBtn?.setAttribute('aria-pressed', data.state === 'like' ? 'true' : 'false');
          dislikeBtn?.setAttribute('aria-pressed', data.state === 'dislike' ? 'true' : 'false');
        }catch(err){
          console.error('React failed:', err);
          alert((err && err.message) ? err.message : 'Failed to update reaction.');
        }
      }
      likeBtn?.addEventListener('click', () => react('like'));
      dislikeBtn?.addEventListener('click', () => react('dislike'));
    })();
  </script>


  <script>
    (() => {
      const articleRoot = document.getElementById('articleRoot');
      if (!articleRoot) return;

      const articleid = Number(articleRoot.dataset.articleId || 0);
      const likeBtn = document.getElementById('likeBtn');
      const dislikeBtn = document.getElementById('dislikeBtn');
      const likeCountEl = document.getElementById('likeCount');
      const dislikeCountEl = document.getElementById('dislikeCount');

      const REACT_API = "/subscriber/api/article/react";  // path you exposed below

      let busy = false;
      async function sendReaction(action){
        if (busy || !articleid) return;
        busy = true;
        [likeBtn, dislikeBtn].forEach(b=>b?.setAttribute('disabled','disabled'));
        try{
          const res = await fetch(REACT_API, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ articleid, action })  // 'like' | 'dislike'
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok || !data.ok){
            console.error('React error:', data);
            alert(data.message || 'Unable to record reaction.');
            return;
          }
          // Update counts & pressed state
          if (likeCountEl) likeCountEl.textContent = data.likes;
          if (dislikeCountEl) dislikeCountEl.textContent = data.dislikes;
          likeBtn?.setAttribute('aria-pressed', data.state === 'like' ? 'true':'false');
          dislikeBtn?.setAttribute('aria-pressed', data.state === 'dislike' ? 'true':'false');
        } catch (err){
          console.error(err);
          alert('Request failed.');
        } finally {
          busy = false;
          [likeBtn, dislikeBtn].forEach(b=>b?.removeAttribute('disabled'));
        }
      }

      likeBtn?.addEventListener('click', () => sendReaction('like'));
      dislikeBtn?.addEventListener('click', () => sendReaction('dislike'));
    })();
    </script>

  <!-- Comments + Report logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ---------- Constants ----------
      const ARTICLE_ID = Number(document.getElementById('articleRoot')?.dataset.articleId || 0);
      const LIST   = document.getElementById('cList');
      const FORM   = document.getElementById('cForm');
      const INPUT  = document.getElementById('cInput');

      // API endpoints
      const API_LIST   = "{{ url_for('subscriber_api_comments') }}";
      const API_CREATE = "{{ url_for('subscriber_api_comment_create') }}";
      const PROFILE_URL_TPL = "{{ url_for('subscriber_profile_view', user_id=0) }}";
      const API_EDIT   = (id)=> `/subscriber/api/comments/${id}`;
      const API_REACT  = (id)=> `/subscriber/api/comments/${id}/react`;
      const API_R_ART  = "/subscriber/report_article";
      const API_R_COMM = "/subscriber/report_comment";

      // Shared report modal nodes
      const overlay   = document.getElementById('reportOverlay');
      const modalCard = overlay?.querySelector('.report-modal-card');   
      const titleEl   = overlay?.querySelector('.report-modal-title')   
                      || overlay?.querySelector('.report-title');

      const reasonSel = document.getElementById('reportReason');
      const noteTxt   = document.getElementById('reportNote');
      const btnCancel = document.getElementById('reportCancel');
      const btnSubmit = document.getElementById('reportSubmit');

      let reportTarget = { type: null, id: null };

      // ---------- Utilities ----------
      const esc = s => (s||"").replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
      const initials = name => {
        const parts = String(name||'').trim().split(/\s+/).slice(0,2);
        return parts.map(p => (p[0]||'').toUpperCase()).join('') || 'U';
      };
      const fmtDate = iso => {
        if(!iso) return '';
        const d = new Date(iso);
        if(isNaN(d)) return iso;
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        let h = d.getHours(), ampm = h>=12?'PM':'AM'; h = h%12 || 12;
        const HH = String(h).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        const ss = String(d.getSeconds()).padStart(2,'0');
        return `${dd}/${mm}/${yyyy}, ${HH}:${mi}:${ss} ${ampm}`;
      };

      // ---------- Comment rendering ----------
      function renderComment(c, depth = 0){
        const indent = Math.min(depth*20, 160);
        const likePressed    = c.my_reaction === 'like' ? 'true' : 'false';
        const dislikePressed = c.my_reaction === 'dislike' ? 'true' : 'false';

        // avatar + name ‚Üí link to subscriberProfileView.html (to be built later)
        const profileId  = c.author_id || c.userid || "";
        const profileHref = PROFILE_URL_TPL.replace(/0$/, String(profileId || "0"));


        const avatarHtml = c.author_image
          ? `<a class="c-avatar" href="${profileHref}" aria-label="${esc(c.author)}"><img src="${esc(c.author_image)}" alt=""></a>`
          : `<a class="c-avatar" href="${profileHref}" aria-label="${esc(c.author)}">${esc(initials(c.author))}</a>`;

        const nameHtml = `<a class="comment-name" href="${profileHref}">${esc(c.author)}</a>`;

        // Right-side actions (kebab only if not mine)
        const right = `
          <div class="c-right-actions">
            ${c.mine ? `
              <span class="c-own-actions">
                <button class="c-edit-btn btn btn-ghost" type="button">Edit</button>
                <button class="c-del-btn  btn btn-ghost" type="button" style="color:#b00;">Delete</button>
              </span>` : `
              <div class="c-more-menu">
                <button class="c-more-btn btn btn-ghost" type="button" aria-haspopup="true" aria-expanded="false">‚ãØ</button>
                <div class="c-more-dropdown" role="menu">
                  <button class="btn btn-ghost c-report-btn" type="button" role="menuitem">Report</button>
                  <button class="btn btn-ghost c-hide-btn"   type="button" role="menuitem">Hide comment</button>
                </div>
              </div>`}
          </div>`;

        return `
          <article class="comment-card ${depth>0?'reply':''}" data-id="${c.commentid}"
                   data-parent="${c.parent_id || ''}" style="margin-left:${indent}px;">
            <div class="comment-meta">
              ${avatarHtml}
              ${nameHtml}
              <span class="comment-time">${esc(fmtDate(c.created_at))}</span>
            </div>

            <div class="c-body">
              <p class="c-text">${esc(c.text)}</p>

              <div class="c-reply-box" style="display:none; margin-top:8px;">
                <textarea class="c-reply-input" placeholder="Write a reply‚Ä¶"></textarea>
                <div style="margin-top:6px; display:flex; gap:8px;">
                  <button class="btn btn-primary c-reply-send"  type="button">Reply</button>
                </div>
              </div>

              ${c.mine ? `
                <div class="c-edit" style="display:none;">
                  <textarea class="c-edit-input"></textarea>
                  <div class="c-edit-actions">
                    <button class="btn btn-light c-edit-cancel" type="button">Cancel</button>
                    <button class="btn btn-primary c-edit-save"  type="button">Save</button>
                  </div>
                </div>` : ``}
            </div>

            <div class="c-actions">
              <div class="c-left-actions">
                <button class="c-like btn btn-ghost" data-val="1" aria-pressed="${likePressed}">
                  üëç <span class="c-like-count">${c.likes}</span>
                </button>
                <button class="c-dislike btn btn-ghost" data-val="-1" aria-pressed="${dislikePressed}">
                  üëé <span class="c-dislike-count">${c.dislikes}</span>
                </button>
                <button class="c-reply-btn btn btn-ghost" type="button">Reply</button>
              </div>
              ${right}
            </div>

            <div class="c-children"></div>
          </article>`;
      }

      function buildTree(flat) {
        const map = new Map();
        flat.forEach(r => map.set(r.commentid, {...r, children: []}));
        const roots = [];
        map.forEach(node => {
          const pid = node.parent_id || null;
          if (pid && map.has(pid)) map.get(pid).children.push(node);
          else roots.push(node);
        });
        (function sortRec(arr, depth=0){
          arr.sort((a,b)=>{
            const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
            const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
            return depth===0 ? tb-ta : ta-tb; // newest-first roots, oldest-first replies
          });
          arr.forEach(n=>sortRec(n.children, depth+1));
        })(roots);
        return roots;
      }
      function renderTree(nodes, depth=0){
        return nodes.map(n => {
          const html = renderComment(n, depth);
          const kids = n.children?.length ? renderTree(n.children, depth+1).join('') : '';
          return html + kids;
        });
      }

async function loadComments(){
  LIST.innerHTML = '';
  try{
    const res  = await fetch(`${API_LIST}?article_id=${ARTICLE_ID}`);
    const raw  = res.ok ? await res.json() : [];

const rows = raw.map(r => ({
  commentid:    r.commentid ?? r.commentID,   // <-- ensure 'commentid' exists
  commentID:    r.commentID ?? r.commentid,   // (optional, for safety)
  text:         r.text ?? r.comment_text ?? "",
  likes:        Number(r.likes ?? 0),
  dislikes:     Number(r.dislikes ?? 0),
  created_at:   r.created_at,
  author:       r.author ?? "Anonymous",
  author_image: r.author_image ?? null,
  mine:         !!r.mine,
  my_reaction:  r.my_reaction ?? null,
  is_reply:     !!(r.is_reply ?? r.isReply),
  parent_id:    r.parent_id ?? r.reply_to_comment_id ?? null,
  author_id:    r.author_id ?? r.userID ?? r.userid ?? null
}));

    if(!rows.length){ LIST.innerHTML = '<p class="c-empty">Be the first to comment.</p>'; return; }

    const tree = buildTree(rows); // buildTree/renderComment already use commentID/parent_id etc.
    LIST.innerHTML = renderTree(tree).join('');
  }catch(err){
    console.error(err);
    LIST.innerHTML = '<p class="c-empty">Failed to load comments.</p>';
  }
}


      // Create new top-level comment
      FORM?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = (INPUT.value||'').trim();
        if (!text) return;
        const fd = new FormData();
        fd.set('articleid', ARTICLE_ID);
        fd.set('text', text);
        try{
          const res = await fetch(API_CREATE, { method:'POST', body: fd });
          const data = res.ok ? await res.json() : null;
          if (res.ok && data?.ok) {
            INPUT.value = '';
            await loadComments();
          } else {
            const msg = data?.error || 'Failed to post. \n Comment contains profanity.';
            showPopup("Comment Rejected", msg);
          }
        }catch(err){ console.error(err); }
      });

      // Delegated comment actions
      LIST.addEventListener('click', async (e)=>{
        const card = e.target.closest('.comment-card'); if (!card) return;
        const id = card.dataset.id;

        // Like/Dislike
        if (e.target.closest('.c-like') || e.target.closest('.c-dislike')){
          const action = e.target.closest('.c-like') ? 'like' : 'dislike';
          try{
            const res = await fetch(API_REACT(id), {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ action })
            });
            const data = res.ok ? await res.json() : null;
            if (data?.ok){
              card.querySelector('.c-like-count').textContent    = data.likes;
              card.querySelector('.c-dislike-count').textContent = data.dislikes;
              card.querySelector('.c-like')   .setAttribute('aria-pressed', data.state==='like' ? 'true':'false');
              card.querySelector('.c-dislike').setAttribute('aria-pressed', data.state==='dislike' ? 'true':'false');
            }
          }catch(err){ console.error(err); }
          return;
        }

        // Reply toggle
        if (e.target.closest('.c-reply-btn')){
          const btn = e.target.closest('.c-reply-btn');
          const box = card.querySelector('.c-reply-box'); 
          if (!box) return;
          const open = box.style.display !== 'none';
          if (open){
            box.style.display = 'none';
            btn.textContent = 'Reply';
          } else {
            box.style.display = 'block';
            btn.textContent = 'Cancel';
            const ta = box.querySelector('.c-reply-input');
            if (ta){
              const name = card.querySelector('.comment-name')?.textContent || '';
              ta.value = `@${name} `;
              ta.focus();
              ta.selectionStart = ta.selectionEnd = ta.value.length;
            }
          }
          return;
        }

        // Cancel reply
        if (e.target.closest('.c-reply-cancel')){
          const box = card.querySelector('.c-reply-box'); if (box) box.style.display = 'none';
          return;
        }

        // Send reply
        if (e.target.closest('.c-reply-send')){
          const box = card.querySelector('.c-reply-box'); if (!box) return;
          const ta  = box.querySelector('.c-reply-input');
          const text = (ta.value || '').trim();
          if (!text) return;

          const fd = new FormData();
          fd.set('articleid', ARTICLE_ID);  
          fd.set('text', text);
          fd.set('parent_id', id);          

          try{
            const res  = await fetch(API_CREATE, { method:'POST', body: fd });
            const data = res.ok ? await res.json() : null;
            if (res.ok && data?.ok){
              await loadComments();
              const opener = card.querySelector('.c-reply-btn');
              if (opener) opener.textContent = 'Reply';
            } else {
              const msg = data?.error || 'Failed to post reply\n Reply contains profanity.';
              showPopup("Reply Rejected", msg);
            }
          }catch(err){ console.error(err); }
          return;
        }

        // Edit on
        if (e.target.closest('.c-edit-btn')){
          const body = card.querySelector('.c-text');
          const wrap = card.querySelector('.c-edit');
          const input= card.querySelector('.c-edit-input');
          if (!wrap || !body || !input) return;
          wrap.style.display='block'; body.style.display='none'; input.value = body.textContent; input.focus();
          return;
        }

        // Edit cancel
        if (e.target.closest('.c-edit-cancel')){
          const body = card.querySelector('.c-text'); const wrap = card.querySelector('.c-edit');
          if (wrap) wrap.style.display='none'; if (body) body.style.display='block';
          return;
        }

        // Edit save
        if (e.target.closest('.c-edit-save')){
          const input = card.querySelector('.c-edit-input'); const newText = (input.value||'').trim();
          if (!newText) return;
          try{
            const res = await fetch(API_EDIT(id), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: newText }) });
            if (res.ok) loadComments();
          }catch(err){ console.error(err); }
          return;
        }

        // Delete
        if (e.target.closest('.c-del-btn')){
          if (!confirm('Delete this comment?')) return;
          try{
            const res = await fetch(API_EDIT(id), { method:'DELETE' });
            if (res.ok) loadComments();
          }catch(err){ console.error(err); }
          return;
        }

        // ‚ãØ dropdown toggle
        if (e.target.closest('.c-more-btn')){
          const menu = card.querySelector('.c-more-dropdown');
          if (menu){
            const open = menu.style.display === 'block';
            document.querySelectorAll('.c-more-dropdown').forEach(m=>m.style.display='none');
            menu.style.display = open ? 'none' : 'block';
          }
          e.stopPropagation();
          return;
        }

        // Report comment
        if (e.target.closest('.c-report-btn')){
          document.querySelectorAll('.c-more-dropdown').forEach(m=>m.style.display='none');
          openReport('comment', Number(id));
          e.stopPropagation();
          return;
        }

        // Hide / Show comment
        if (e.target.closest('.c-hide-btn')){
          const body = card.querySelector('.c-body');
          const actions = card.querySelector('.c-actions');
          if (!card.querySelector('.c-hidden')){
            const ph = document.createElement('div');
            ph.className = 'c-hidden';
            ph.innerHTML = `Comment hidden. <button class="btn btn-ghost c-show-btn" type="button">Show</button>`;
            card.appendChild(ph);
          }
          if (body) body.style.display = 'none';
          if (actions) actions.style.display = 'none';
          document.querySelectorAll('.c-more-dropdown').forEach(m=>m.style.display='none');
          return;
        }
        if (e.target.closest('.c-show-btn')){
          const body = card.querySelector('.c-body');
          const actions = card.querySelector('.c-actions');
          const ph = card.querySelector('.c-hidden');
          if (body) body.style.display = '';
          if (actions) actions.style.display = '';
          if (ph) ph.remove();
          return;
        }
      });

      document.addEventListener('click', () => {
        document.querySelectorAll('.c-more-dropdown').forEach(m=>m.style.display='none');
      });

      // Article report
      document.getElementById('articleReportBtn')?.addEventListener('click', () => {
        openReport('article', ARTICLE_ID);
      });

      // Report modal helpers
      function openReport(type, id){
        reportTarget = { type, id };
        if (titleEl)  titleEl.textContent = (type === 'article') ? 'Report Article' : 'Report Comment';
        if (reasonSel) reasonSel.value = '';
        if (noteTxt)   noteTxt.value   = '';
        overlay?.classList.add('show');               // CSS: .report-modal-overlay.show { display:flex }
        overlay?.setAttribute('aria-hidden', 'false');
      }

      function closeReport(){
        overlay?.classList.remove('show');
        overlay?.setAttribute('aria-hidden', 'true');
        reportTarget = { type:null, id:null };
      }

      // prevent clicks INSIDE the modal from closing it
      modalCard?.addEventListener('click', (e) => e.stopPropagation());

      // only clicks on the dark overlay (outside the card) should close
      overlay?.addEventListener('click', (e) => {
        if (e.target === overlay) closeReport();
      });

      btnCancel?.addEventListener('click', closeReport);

      btnSubmit?.addEventListener('click', async () => {
        if (!reportTarget.type || !reportTarget.id) return;
        const reason  = (reasonSel?.value || '').trim();
        const details = (noteTxt?.value || '').trim();
        if (!reason){ alert('Please select a reason.'); return; }

        const path = (reportTarget.type === 'article') ? API_R_ART : API_R_COMM;

        try{
          const res = await fetch(path, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ id: Number(reportTarget.id), reason, details })
          });
          const data = await res.json().catch(()=> ({}));
          if (res.ok && data?.ok){
            alert('Report submitted. Thank you.');
            closeReport();
          }else{
            alert(data?.message || 'Failed to submit report.');
          }
        }catch(err){
          console.error(err);
          alert('Failed to submit report.');
        }
      });

      // Initial comments load
      loadComments();
    });
  </script>

  <!-- Share -->
  <script>
    (function() {
      const shareBtn = document.getElementById("shareBtn");
      if (!shareBtn) return;
      shareBtn.addEventListener("click", () => {
        const url = window.location.href;
        const titleEl = document.querySelector(".article-title");
        const title = titleEl ? titleEl.innerText : document.title;
        if (navigator.share) {
          navigator.share({ title, url }).catch(err => console.error("Share failed:", err));
        } else {
          navigator.clipboard.writeText(url).then(() => alert("Link copied to clipboard!"));
        }
      });
    })();
  </script>

  <!-- Ads Box -->
  <script>
    (function(){
      const adsBox   = document.getElementById('adsBox');
      if (adsBox) adsBox.classList.add('fixed');
      const ADS_API  = "{{ url_for('api_random_ad') }}";
      const esc = s => (s||"").replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      function renderAd(ad){
        if(!adsBox) return;
        adsBox.innerHTML = `
          <a class="ad-link" href="${esc(ad.website)}" target="_blank" rel="noopener">
            <img class="ad-image" src="${esc(ad.image)}" alt="${esc(ad.title || 'Advertisement')}">
          </a>
        `;
      }
      async function loadAd(){
        try{
          const res = await fetch(ADS_API, {cache:'no-store'});
          if(!res.ok) return;
          const data = await res.json();
          if(data?.ok && data.ad) renderAd(data.ad);
        }catch(_){}
      }
      loadAd();
      setInterval(loadAd, 10_000);
    })();
  </script>

  <script>
  (function(){
    // --- Small helpers ---
    const clampChars = (s, max=160) => {
      s = (s||"").trim().replace(/\s+/g," ");
      if (s.length <= max) return s;
      const cut = s.slice(0, max);
      const i = cut.lastIndexOf(" ");
      return (i > 80 ? cut.slice(0, i) : cut).trim() + "‚Ä¶";
    };

    // Split article text into candidate sentences
    function splitSentences(text){
      const clean = String(text||"").replace(/\s+/g," ").trim();
      if (!clean) return [];
      return clean.split(/(?<=[.!?„ÄÇÔºÅÔºü])\s+/).map(s => s.trim()).filter(Boolean);
    }

    // Score sentences: prefer those with numbers/percentages/dates and named words
    function scoreSentence(s){
      let score = 0;
      if (/\d/.test(s)) score += 3;                
      if (/%/.test(s)) score += 2;
      if (/\b(s$|ing\b|ed\b)/i.test(s)) score += 1;  
      if (/\b(launch|policy|trial|deal|merger|funding|ban|fine|record|growth|drop|rise|court|minister|parliament|update|deadline)\b/i.test(s)) score += 2;
      const caps = (s.match(/\b[A-Z][a-z]{2,}\b/g)||[]).length;
      score += Math.min(caps, 3);
      const len = s.length; if (len >= 50 && len <= 240) score += 1;
      return score;
    }

    // Generate bullets from article text (3‚Äì5 points)
    function generateKeyPointsFrom(text, maxPoints=5){
      const sents = splitSentences(text);
      if (!sents.length) return [];
      const ranked = sents.map(s => ({ s, score: scoreSentence(s) }))
                          .sort((a,b)=>b.score-a.score);
      const seen = new Set(), picks = [];
      for (const r of ranked){
        const key = r.s.toLowerCase().replace(/[^a-z0-9 ]/g,"").split(" ").slice(0,6).join(" ");
        if (seen.has(key)) continue;
        seen.add(key);
        picks.push(clampChars(r.s, 160));
        if (picks.length >= maxPoints) break;
      }
      if (picks.length < 3){
        for (const r of sents){
          picks.push(clampChars(r, 160));
          if (picks.length >= Math.min(3,maxPoints)) break;
        }
      }
      return picks;
    }

    // Clamp an existing summary list down to maxPoints / maxChars
    function clampExistingSummary(ul, maxPoints=5, maxChars=160){
      if (!ul) return;
      const items = Array.from(ul.querySelectorAll("li"));
      if (!items.length) return;
      items.forEach(li => li.textContent = clampChars(li.textContent, maxChars));
      items.slice(maxPoints).forEach(li => li.remove());
    }

    // Ensure there is a short bullet summary
    function ensureShortSummary(){
      const ul = document.getElementById("summaryList");
      const box = document.querySelector(".summary-box");

      if (ul && ul.children.length){
        clampExistingSummary(ul, 5, 160);
        return;
      }

      // Build a new summary box if missing/empty
      const articleText = (document.querySelector(".article-content")?.innerText || "").trim();
      const points = generateKeyPointsFrom(articleText, 5);
      if (!points.length) return;

      const container = box || document.createElement("div");
      container.className = "summary-box";
      container.innerHTML = `<h3>Summary</h3><ul id="summaryList"></ul>`;
      const list = container.querySelector("#summaryList");
      points.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p;
        list.appendChild(li);
      });

      if (!box){
        const header = document.querySelector(".article-header");
        (header && header.parentNode) ? header.parentNode.insertBefore(container, header.nextSibling)
                                      : document.querySelector(".article-view").prepend(container);
      }
    }

    // Run once when page loads
    window.addEventListener("DOMContentLoaded", ensureShortSummary);

    // Expose a hook so your translator can re-clamp after updating text
    window._clampSummaryNow = function(){
      const ul = document.getElementById("summaryList");
      if (ul && ul.children.length) clampExistingSummary(ul, 5, 160);
      else ensureShortSummary();
    };
  })();
  </script>

  <!-- Translate helpers -->
  <script>
    let originalTitle = "", originalContent = "", originalSummary = [];
    window.addEventListener("DOMContentLoaded", () => {
      originalTitle = document.querySelector(".article-title")?.innerText || "";
      const contentEl = document.querySelector(".article-content");
      originalContent = contentEl ? contentEl.innerText : "";
      originalSummary = Array.from(document.querySelectorAll("#summaryList li")).map(li => li.innerText);
    });
    async function translateArticle() {
      const lang = document.getElementById("language")?.value;
      if (!lang) return;
      if (lang === "en") {
        const tEl = document.querySelector(".article-title"); if (tEl) tEl.innerText = originalTitle;
        const cEl = document.querySelector(".article-content"); if (cEl) cEl.innerText = originalContent;
        const items = document.querySelectorAll("#summaryList li");
        originalSummary.forEach((t, i) => { if (items[i]) items[i].innerText = t; });
        window.currentTTSLang = 'en';
        window._clampSummaryNow && window._clampSummaryNow();   // <<< add this
        return;
      }
      try {
        const res = await fetch("/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: originalTitle,
            content: originalContent,
            summary: originalSummary,
            target_lang: lang
          })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        const tEl = document.querySelector(".article-title");
        if (tEl) tEl.innerText = data.title || originalTitle;
        const cEl = document.querySelector(".article-content");
        if (cEl) cEl.innerText = data.content || originalContent;
        const items = document.querySelectorAll("#summaryList li");
        (data.summary || []).forEach((t, i) => { if (items[i]) items[i].innerText = t; });
        window.currentTTSLang = lang;
        window._clampSummaryNow && window._clampSummaryNow();
      } catch (err) {
        console.error("Translation error:", err);
      }
    }
  </script>

  <!-- Logout modal wiring -->
  <script>
    (function () {
      const modal   = document.getElementById('logoutModal');
      const confirm = document.getElementById('logoutConfirm');
      const cancel  = document.getElementById('logoutCancel');
      document.querySelectorAll('.logout-link').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          modal.dataset.href = a.getAttribute('href');
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
        });
      });
      function closeModal() {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        delete modal.dataset.href;
      }
      if (cancel)  cancel.addEventListener('click', closeModal);
      if (confirm) confirm.addEventListener('click', async () => {
        const href = modal.dataset.href || "{{ url_for('logout') }}";
        const success = document.getElementById('logoutSuccess');
        try {
          await fetch(href, { method: 'GET', redirect: 'manual', credentials: 'include' });
        } catch (_) { /* ignore */ }
        closeModal();
        if (success) {
          success.style.display = 'flex';
          success.classList.add('show');
        }
        setTimeout(() => {
          window.location.href = "{{ url_for('index') }}";
        }, 1000);  
      });

      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('show')) closeModal();
      });
      // Footer year
      const y = document.getElementById('footer-year'); if (y) y.textContent = new Date().getFullYear();
      // bfcache
      window.addEventListener('pageshow', function(event) { if (event.persisted) window.location.reload(); });
    })();

    // Simple reusable popup function
    function showPopup(title, message) {
      const modal  = document.getElementById('popupModal');
      const msgEl  = document.getElementById('popupMessage');
      const titleEl = document.getElementById('popupTitle');
      const closeBtn = document.getElementById('popupClose');

      titleEl.textContent = title || 'Notice';
      msgEl.innerHTML = (message || '').replace(/\n/g, '<br>');  // <-- changed line
      modal.style.display = 'flex';

      const hide = ()=> modal.style.display = 'none';
      closeBtn.onclick = hide;
      modal.onclick = (e)=> { if(e.target===modal) hide(); };
    }
  </script>

  <!-- Accessibility widget + Chatbot include -->
  <script src="{{ url_for('static', filename='js/accessibility_toolbar.js') }}"></script>
  {% include 'partials/chatbot.html' %}

<!-- Reusable popup modal -->
<div id="popupModal" class="popup-modal" style="display:none;">
  <div class="popup-content">
    <h3 id="popupTitle">Notice</h3>
    <p id="popupMessage"></p>
    <button id="popupClose" class="btn btn-primary">OK</button>
  </div>
</div>

<style>
  .popup-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .popup-content {
    background: #fff;
    border-radius: 10px;
    padding: 24px 32px;
    max-width: 360px;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    animation: fadeInUp 0.3s ease;
  }
  .popup-content h3 {
    margin-top: 0;
    color: #d00;
  }
  .popup-content p {
    margin: 12px 0 20px;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
(function () {
  const btn    = document.getElementById('notifBtn');
  const badge  = document.getElementById('notifBadge');
  const panel  = document.getElementById('notifPanel');
  const listEl = document.getElementById('notifList');
  const emptyEl= panel ? panel.querySelector('.notif-empty') : null;
  const markAll= document.getElementById('notifMarkAll');

  if (!btn || !panel || !listEl || !emptyEl || !markAll) return;

  // Format MySQL datetime -> "DD/MM/YYYY, H,MM am/pm"
  function formatSqlDate(s) {
    if (!s) return '';

    let d = new Date(s);       

    // If that failed (NaN), try "YYYY-MM-DD HH:MM:SS"
    if (isNaN(d.getTime())) {
      const str = String(s).trim();
      const m = str.match(/^(\d{4})-(\d{2})-(\d{2})[ ](\d{2}):(\d{2})(?::(\d{2}))?/);
      if (!m) return str;
      d = new Date(
        Number(m[1]),          // year
        Number(m[2]) - 1,      // month 0‚Äì11
        Number(m[3]),          // day
        Number(m[4]),          // hour
        Number(m[5]),          // minute
        Number(m[6] || 0)      // second
      );
    }

    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const pad  = n => String(n).padStart(2, '0');

    const dayName = days[d.getDay()];
    const dd      = pad(d.getDate());
    const mm      = pad(d.getMonth() + 1);
    const yyyy    = d.getFullYear();

    let h   = d.getHours();
    const ampm = h >= 12 ? 'pm' : 'am';
    const h12  = (h % 12) || 12;
    const mins = pad(d.getMinutes());

    // Day, DD/MM/YYYY HH:MM (am/pm)
    return `${dayName}, ${dd}/${mm}/${yyyy} ${h12}:${mins} ${ampm}`;
  }

  // HTML escape (works for numbers too)
  const esc = s => String(s ?? '').replace(/[&<>"]/g, c => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;'
  }[c]));

  function fmtItem(it) {
    const who   = (it.actor_name && it.actor_name.trim())
                  || (it.actor_id ? 'User #' + it.actor_id : 'Someone');
    const when  = formatSqlDate(it.ts);
    const title = (it.article_title && it.article_title.trim()) || '(untitled article)';

    const href  = '/subscriber/article/' + it.article_id;
    const link  =
      '<a href="' + href + '" class="notif-link" ' +
      'data-kind="' + esc(it.kind) + '" ' +
      'data-id="' + esc(it.id) + '" ' +
      'data-article="' + esc(it.article_id) + '"' +
      (it.comment_id ? ' data-comment="' + esc(it.comment_id) + '"' : '') +
      '>' + esc(title) + '</a>';

    // 1) Article like / dislike
    if (it.kind === 'article_reaction') {
      return '<li><b>' + esc(who) + '</b> ' + esc(it.action) +
             'd your article ' + link +
             ' <span style="color:#888">¬∑ ' + when + '</span></li>';
    }

    // 2) Reply to your comment
    if (it.kind === 'comment_reply') {
      return '<li><b>' + esc(who) + '</b> replied to your comment on ' + link +
             ' <span style="color:#888">¬∑ ' + when + '</span></li>';
    }

    // 3) Like / dislike on your comment
    if (it.kind === 'comment_reaction') {
      return '<li><b>' + esc(who) + '</b> ' + esc(it.action) +
             'd your comment on ' + link +
             ' <span style="color:#888">¬∑ ' + when + '</span></li>';
    }

    // 4) Comment reported (pending / reviewed / removed)
    if (it.kind === 'comment_report') {
      const st = (it.action || '').toLowerCase();  // cp.status
      let statusMsg;
      if (st === 'pending') {
        statusMsg = 'has been reported and is pending moderator review';
      } else if (st === 'reviewed') {
        statusMsg = 'has been reviewed by a moderator';
      } else if (st === 'removed') {
        statusMsg = 'has been removed by a moderator';
      } else {
        statusMsg = 'has an updated status: ' + esc(it.action || '');
      }
      const reasonText = it.reason ? ' (Reason: ' + esc(it.reason) + ')' : '';
      return '<li>Your comment on ' + link + ' ' + statusMsg + reasonText +
             ' <span style="color:#888">¬∑ ' + when + '</span></li>';
    }

    // 5) Article reported (pending / reviewed / dismissed)
    if (it.kind === 'article_report') {
      const st = (it.action || '').toLowerCase();  // ap.status
      let statusMsg;
      if (st === 'pending') {
        statusMsg = 'has been reported and is pending moderator review';
      } else if (st === 'reviewed') {
        statusMsg = 'has been reviewed by a moderator';
      } else if (st === 'dismissed') {
        statusMsg = 'report has been dismissed by a moderator';
      } else {
        statusMsg = 'has an updated status: ' + esc(it.action || '');
      }
      const reasonText = it.reason ? ' (Reason: ' + esc(it.reason) + ')' : '';
      return '<li>Your article ' + link + ' ' + statusMsg + reasonText +
             ' <span style="color:#888">¬∑ ' + when + '</span></li>';
    }

    // Fallback
    return '<li>New activity on ' + link +
           ' <span style="color:#888">¬∑ ' + when + '</span></li>';
  }

  async function loadNotifs() {
    try {
      const r = await fetch('/api/notifications', { cache: 'no-store' });
      const data = await r.json();
      if (!data.ok) throw new Error('bad response');

      const items = Array.isArray(data.items) ? data.items : [];

      // badge
      if (data.unread > 0) {
        badge.textContent = data.unread > 99 ? '99+' : String(data.unread);
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      // list
      listEl.innerHTML = items.map(fmtItem).join('');
      if (items.length === 0) {
        emptyEl.classList.remove('hidden');
      } else {
        emptyEl.classList.add('hidden');
      }
    } catch (e) {
      // on error, show "No new notifications"
      listEl.innerHTML = '';
      emptyEl.classList.remove('hidden');
    }
  }

  // Panel open/close
  const toggle = () => {
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
  };
  const hide = () => { panel.style.display = 'none'; };

  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggle();
  });
  document.addEventListener('click', (e) => {
    if (!panel.contains(e.target) && e.target !== btn) hide();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hide();
  });

  // Mark all as read
  markAll.addEventListener('click', async () => {
    try {
      await fetch('/api/notifications/mark_read', { method: 'POST' });
      hide();
      badge.classList.add('hidden');
      listEl.innerHTML = '';
      emptyEl.classList.remove('hidden');
    } catch (_) {}
  });

  // When a notification link is clicked, mark that one, then go to article
  document.addEventListener('click', async (e) => {
    const a = e.target.closest('a.notif-link');
    if (!a) return;
    e.preventDefault();

    const kind = a.dataset.kind;
    const id   = Number(a.dataset.id);
    const href = a.getAttribute('href');

    try {
      await fetch('/api/notifications/mark_one', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ kind, id })
      });
    } catch (_) {}

    if (a.dataset.comment) {
      window.location.href = href + '#c' + a.dataset.comment;
    } else {
      window.location.href = href;
    }
  });

  // initial + polling
  loadNotifs();
  setInterval(loadNotifs, 15000);
})();
</script>


  <script>
  document.addEventListener("click", async (e) => {
    const a = e.target.closest("a.notif-link");
    if (!a) return;
    e.preventDefault();

    const kind = a.dataset.kind;
    const id   = Number(a.dataset.id);
    const href = a.getAttribute("href");

    try {
      await fetch("/api/notifications/mark_one", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ kind, id })
      });
    } catch (_) {}

    if (a.dataset.comment) {
      window.location.href = href + "#c" + a.dataset.comment;
    } else {
      window.location.href = href;
    }
  });
  </script>

  <script>
    const NOTIF_VIEW_URL = "{{ url_for('subscriber_article_view', article_id=0) }}";
    function articleHref(id) { return NOTIF_VIEW_URL.replace(/0$/, String(id)); }
  </script>

</body>
</html>
