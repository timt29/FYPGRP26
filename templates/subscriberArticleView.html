<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ article.title }} ‚Äî EchoPress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" type="image/png" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subscriber.css') }}">
</head>
<body>

  <!-- Top Bar -->
  <header class="topbar">
    <div class="left">
      <button type="button" class="brand" onclick="window.location.href='{{ url_for('subscriberHomepage') }}'">
        <img src="{{ url_for('static', filename='img/echopresslogo.png') }}" alt="EchoPress" />
      </button>

      <!-- In-page subscriber search -->
      <form id="subSearchForm" class="search" action="#" method="get" role="search">
        <input id="subSearchQ" type="text" name="q" placeholder="Searching for‚Ä¶ ?" aria-label="Search" />
        <button type="submit" aria-label="Search">Search</button>
      </form>
    </div>

    <div class="right">
      <span class="welcome">Welcome, {{ session.get('user','Subscriber') }} !</span>
      <button id="menuBtn" class="burger" aria-label="Menu"><span></span><span></span><span></span></button>
      <div id="menuPanel" class="menu-panel">
        <a class="menu-item" href="{{ url_for('subscriber_my_articles') }}">View My Articles</a>
        <a class="menu-item" href="{{ url_for('subscriber_bookmarks') }}">View Bookmark</a>
        <span class="menu-item">View Analytics</span>
        <span class="menu-item">Edit Profile</span>
        <a class="menu-item" href="{{ url_for('logout') }}">Log Out</a>
      </div>
    </div>
  </header>

  <!-- Page -->
  <main class="page">

    <!-- ===== ARTICLE VIEW (hidden when showing results) ===== -->
    <section id="articleSection" class="feed">
      <article id="articleRoot" class="article-card detail article-view" data-article-id="{{ article.articleID }}">
        <header class="article-header">
          <h1 class="article-title">{{ article.title }}</h1>
        </header>

        <!-- RIGHT-ALIGNED ACTION BAR -->
        <div class="action-bar">
          <button id="bookmarkBtn" class="btn btn-ghost" aria-pressed="{{ 'true' if is_pinned else 'false' }}">
            <span class="pin-icon" aria-hidden="true">üìå</span>
            <span class="label">{{ 'Remove Bookmark' if is_pinned else 'Add Bookmark' }}</span>
          </button>

          <div id="ttsWrap">
            <button id="ttsStart" class="btn btn-ghost">
              <span aria-hidden="true">üîä</span> Read Article
            </button>
            <div id="ttsControls" class="tts-controls hidden">
              <button id="ttsPause"  class="btn btn-ghost">Pause</button>
              <button id="ttsResume" class="btn btn-ghost">Continue</button>
              <button id="ttsReplay" class="btn btn-ghost">Replay</button>
            </div>
          </div>
        </div>

        <!-- Two-column body: text + image -->
        <div class="article-body two-col">
          <div class="article-content">
            {{ article.content | safe }}
          </div>

          {% if article.image %}
            <div class="thumb-wrap side">
              <img src="{{ article.image }}" alt="Article image">
            </div>
          {% endif %}
        </div>

        <div class="meta">
          <span><strong>{{ article.author or 'EchoPress' }}</strong></span>
          {% if article.category %}<span>‚Ä¢ {{ article.category }}</span>{% endif %}
          {% if article.published_at %}<span>‚Ä¢ Published {{ article.published_at }}</span>{% endif %}
          {% if article.updated_at %}<span>‚Ä¢ Updated {{ article.updated_at }}</span>{% endif %}
        </div>

        <div class="share-button">
          <button id="shareBtn" class="btn btn-ghost" title="Share">
            <img src="{{ url_for('static', filename='img/share.png') }}" alt="Share" style="width:20px; vertical-align:middle;" />
            <span>Share</span>
          </button>
        </div>
      </article>

      <!-- Comments -->
      <section class="card comments">
        <h3 class="comments-title">Comments</h3>

        <!-- Create -->
        <form id="cForm" class="comment-form" autocomplete="off">
          <img src="{{ url_for('static', filename='img/avatar.png') }}" alt="" class="comment-avatar">
          <textarea id="cInput" class="comment-input" rows="3" placeholder="Add a comment‚Ä¶"></textarea>
          <button id="cSend" type="submit" class="btn btn-primary">Send</button>
        </form>

        <!-- List -->
        <div id="cList" class="comment-list"></div>
      </section>
    </section>

    <!-- ===== SEARCH RESULTS (in-page; hides article view) ===== -->
    <section id="resultsSection" class="feed hidden" aria-live="polite" aria-busy="false">
      <div class="results-header">
        <h2 class="results-title">Search results</h2>
        <button id="closeResults" type="button" class="btn btn-light">Close results</button>
      </div>
      <section id="resultsFeed"></section>
    </section>

    <aside class="sidebar">
      <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url_for('subscriberCreateArticle') }}'">
        Create Your Story
      </button>
      <div class="ads">Ads</div>
    </aside>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <span id="toastMsg">Done.</span>
  </div>

  <!-- Topbar menu toggle -->
  <script>
    (function(){
      const btn = document.getElementById('menuBtn');
      const panel = document.getElementById('menuPanel');
      if (!btn || !panel) return;
      const closeP  = () => panel.style.display = 'none';
      const toggleP = () => panel.style.display = panel.style.display==='block' ? 'none' : 'block';
      btn.addEventListener('click', e => { e.stopPropagation(); toggleP(); });
      document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) closeP(); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeP(); });
    })();
  </script>

  <!-- In-page Subscriber Search -->
  <script>
  (function(){
    const API_URL      = "{{ url_for('subscriber_search_api') }}";
    const VIEW_URL_TPL = "{{ url_for('subscriber_article_view', article_id=0) }}";
    const PLACEHOLDER  = "{{ url_for('static', filename='img/placeholder.png') }}";

    const form   = document.getElementById('subSearchForm');
    const input  = document.getElementById('subSearchQ');
    const articleSection = document.getElementById('articleSection');
    const resultsSection = document.getElementById('resultsSection');
    const resultsFeed    = document.getElementById('resultsFeed');
    const closeBtn       = document.getElementById('closeResults');

    const esc = s => (s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const trunc = (t, n=220) => (!t ? "" : (t=t.trim(), t.length>n ? t.slice(0,n-1)+"‚Ä¶" : t));

    function imageCandidates(raw) {
      let v = (raw ?? "").toString().trim();
      const downs = v.toLowerCase();
      if (!v || downs === "null" || downs === "none" || downs === "undefined") return [];

      const fname = v.split("/").pop();
      const list = [];

      if (/^https?:\/\//i.test(v)) list.push(v);
      if (/static\//i.test(v)) list.push(v.startsWith("/") ? v : "/" + v);
      if (!/^https?:\/\//i.test(v) && /\/./.test(v)) {
        list.push(v.startsWith("/") ? v : "/" + v);
        list.push("/static/" + v.replace(/^\/+/, ""));
      }
      if (fname && !v.includes("/")) {
        list.push("/static/uploads/" + fname);
        list.push("/static/img/" + fname);
      }
      return [...new Set(list)];
    }

    function attachImageLoader(img, candidates) {
      if (!candidates.length) { img.src = PLACEHOLDER; return; }
      let idx = 0;
      function tryNext() {
        if (idx >= candidates.length) { img.src = PLACEHOLDER; return; }
        img.src = candidates[idx++];
      }
      img.onerror = tryNext;
      tryNext();
    }

    function card(a){
      const rawImage = a.image ?? a.image_url ?? a.imagePath ?? a.imageName ?? a.cover;
      const cands = imageCandidates(rawImage);
      const id = `img_${a.articleID}_${Math.random().toString(36).slice(2)}`;

      const html = `
        <article class="article-card open-article" data-id="${a.articleID}" role="button" tabindex="0">
          <div class="text">
            <h3>${esc(a.title)}</h3>
            <p class="desc">${esc(trunc(a.content))}</p>
          </div>
          <div class="thumb-wrap"><img id="${id}" alt=""></div>
        </article>`;
      queueMicrotask(() => {
        const img = document.getElementById(id);
        if (img) attachImageLoader(img, cands);
      });
      return html;
    }

    async function runSearch(q){
      resultsSection.setAttribute('aria-busy','true');
      resultsFeed.innerHTML = "";
      try{
        const p = new URLSearchParams({ q, limit: "20" });
        const res = await fetch(`${API_URL}?${p.toString()}`);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const rows = await res.json();
        resultsFeed.innerHTML = rows.length ? rows.map(card).join("") : "<p>No articles found.</p>";
      }catch(err){
        console.error(err);
        resultsFeed.innerHTML = `<p style="color:#b00">Failed to load results.</p>`;
      }finally{
        resultsSection.setAttribute('aria-busy','false');
      }
    }

    function showResults(){ articleSection.classList.add('hidden'); resultsSection.classList.remove('hidden'); }
    function hideResults(){ resultsSection.classList.add('hidden'); articleSection.classList.remove('hidden'); }

    if (form){
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const q = (input.value || '').trim();
        if (!q) { hideResults(); return; }
        showResults();
        runSearch(q);
      });
    }
    if (closeBtn) closeBtn.addEventListener('click', hideResults);
    if (input) input.addEventListener('input', () => { if (input.value.trim()==="") hideResults(); });

    resultsFeed.addEventListener('click', (e) => {
      const el = e.target.closest('.open-article');
      if (!el) return;
      const url = VIEW_URL_TPL.replace(/0$/, el.dataset.id);
      window.location.href = url;
    });
    resultsFeed.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      const el = e.target.closest('.open-article');
      if (!el) return;
      const url = VIEW_URL_TPL.replace(/0$/, el.dataset.id);
      window.location.href = url;
    });
  })();
  </script>

  <!-- Bookmark + TTS -->
  <script>
    (function(){
      const toast   = document.getElementById('toast');
      const msgEl   = document.getElementById('toastMsg');
      const showToast = (m) => { msgEl.textContent = m || 'Done.'; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1400); };

      const bookmarkBtn = document.getElementById('bookmarkBtn');
      const articleRoot = document.getElementById('articleRoot');
      const articleID   = parseInt(articleRoot?.dataset.articleId || '0', 10);
      const endpoint    = "{{ url_for('subscriber_toggle_pin') }}";

      if (bookmarkBtn){
        bookmarkBtn.addEventListener('click', async () => {
          if (!articleID){ showToast('Missing article ID.'); return; }
          try{
            const res  = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ articleID })
            });
            const data = await res.json().catch(()=> ({}));
            if (!res.ok || !data.ok){ throw new Error(data.message || ('HTTP '+res.status)); }
            const nowBookmarked = data.state === 'pinned';
            bookmarkBtn.setAttribute('aria-pressed', nowBookmarked ? 'true' : 'false');
            const label = bookmarkBtn.querySelector('.label');
            if (label) label.textContent = nowBookmarked ? 'Remove Bookmark' : 'Add Bookmark';
            showToast(nowBookmarked ? 'Bookmarked.' : 'Removed from bookmarks.');
          }catch(err){
            showToast('Unable to update bookmark.');
            console.error(err);
          }
        });
      }

      const ttsStart   = document.getElementById('ttsStart');
      const ttsCtrls   = document.getElementById('ttsControls');
      const ttsPause   = document.getElementById('ttsPause');
      const ttsResume  = document.getElementById('ttsResume');
      const ttsReplay  = document.getElementById('ttsReplay');

      const articleText = (() => {
        const el = document.querySelector('.article-content');
        return el ? el.innerText.trim() : '';
      })();

      function speak(text){
        if (!('speechSynthesis' in window)){ showToast('Reader not supported by this browser.'); return; }
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1.0;
        utter.pitch = 1.0;
        window.speechSynthesis.speak(utter);
      }

      if (ttsStart){
        ttsStart.addEventListener('click', () => {
          if (!articleText){ showToast('Nothing to read.'); return; }
          speak(articleText);
          ttsCtrls.classList.remove('hidden');
          ttsStart.classList.add('hidden');
        });
      }
      if (ttsPause){
        ttsPause.addEventListener('click', () => {
          if (window.speechSynthesis.speaking && !window.speechSynthesis.paused){
            window.speechSynthesis.pause();
          }
        });
      }
      if (ttsResume){
        ttsResume.addEventListener('click', () => {
          if (window.speechSynthesis.paused){
            window.speechSynthesis.resume();
          }
        });
      }
      if (ttsReplay){
        ttsReplay.addEventListener('click', () => {
          speak(articleText);
        });
      }

      window.addEventListener('beforeunload', () => {
        if ('speechSynthesis' in window){ window.speechSynthesis.cancel(); }
      });
    })();
  </script>

  <!-- Comments logic -->
  <script>
  (function(){
    const ARTICLE_ID = {{ article.articleID }};
    const LIST   = document.getElementById('cList');
    const FORM   = document.getElementById('cForm');
    const INPUT  = document.getElementById('cInput');

    const API_LIST   = "{{ url_for('subscriber_api_comments') }}";
    const API_CREATE = "{{ url_for('subscriber_api_comment_create') }}";
    const API_EDIT   = (id)=> `/subscriber/api/comments/${id}`;
    const API_REACT  = (id)=> `/subscriber/api/comments/${id}/react`;

    const esc = s => (s||"").replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));

    function commentHTML(c){
      // Map common field names
      const id    = c.commentID ?? c.id;
      const body  = c.text ?? c.body ?? '';
      const user  = c.author ?? c.user_name ?? 'User';
      const when  = c.time_ago ?? c.created_at ?? '';
      const mine  = !!c.mine;
      const likes = Number(c.likes ?? 0);
      const dislikes = Number(c.dislikes ?? 0);
      const myReact = c.my_reaction; // 1, -1, or 0

      return `
      <article class="comment-card" data-id="${id}">
        <div class="comment-meta">
          <img src="{{ url_for('static', filename='img/avatar.png') }}" alt="" class="avatar">
          <span class="comment-name">${esc(user)}</span>
          <span class="comment-time">${esc(when)}</span>
        </div>

        <div class="c-body">
          <p class="c-text">${esc(body)}</p>
          ${mine ? `
            <div class="c-edit">
              <textarea class="c-edit-input" rows="3"></textarea>
              <div class="c-edit-actions">
                <button class="btn btn-light c-edit-cancel" type="button">Cancel</button>
                <button class="btn btn-primary c-edit-save"  type="button">Save</button>
              </div>
            </div>` : ``}
        </div>

        <div class="c-actions">
          <button class="c-like btn btn-ghost" data-val="1" aria-pressed="${myReact===1?'true':'false'}">
            üëç <span class="c-like-count">${likes}</span>
          </button>
          <button class="c-dislike btn btn-ghost" data-val="-1" aria-pressed="${myReact===-1?'true':'false'}">
            üëé <span class="c-dislike-count">${dislikes}</span>
          </button>
          ${mine ? `
            <button class="c-edit-btn btn btn-ghost" type="button">Edit</button>
            <button class="c-del-btn btn btn-ghost" type="button" style="color:#b00;">Delete</button>` : ``}
        </div>
      </article>`;
    }

    async function loadComments(){
      LIST.innerHTML = '';
      try{
        const res = await fetch(`${API_LIST}?article_id=${ARTICLE_ID}`);
        const rows = res.ok ? await res.json() : [];
        LIST.innerHTML = rows.length ? rows.map(commentHTML).join('') : '<p class="c-empty">Be the first to comment.</p>';
      }catch(e){
        console.error(e);
        LIST.innerHTML = '<p class="c-empty">Failed to load comments.</p>';
      }
    }

    // Create
    FORM?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (INPUT.value||'').trim();
      if (!text) return;
      const fd = new FormData();
      fd.set('articleID', ARTICLE_ID);
      fd.set('text', text);
      try{
        const res = await fetch(API_CREATE, { method:'POST', body: fd });
        if (res.ok){ INPUT.value=''; loadComments(); }
      }catch(err){ console.error(err); }
    });

    // Delegated actions
    LIST.addEventListener('click', async (e)=>{
      const card = e.target.closest('.comment-card');
      if (!card) return;
      const id = card.dataset.id;

      // Like/Dislike
      if (e.target.closest('.c-like') || e.target.closest('.c-dislike')){
        const isLike = !!e.target.closest('.c-like');
        const action = isLike ? 'like' : 'dislike';
        try{
          const res = await fetch(API_REACT(id), {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ action })
          });
          const data = res.ok ? await res.json() : null;
          if (data?.ok){
            card.querySelector('.c-like-count').textContent    = data.likes;
            card.querySelector('.c-dislike-count').textContent = data.dislikes;
            card.querySelector('.c-like').setAttribute('aria-pressed', data.state==='like' ? 'true':'false');
            card.querySelector('.c-dislike').setAttribute('aria-pressed', data.state==='dislike' ? 'true':'false');
          }
        }catch(err){ console.error(err); }
        return;
      }

      // Enter edit mode
      if (e.target.closest('.c-edit-btn')){
        const bodyEl   = card.querySelector('.c-text');
        const editWrap = card.querySelector('.c-edit');
        const input    = card.querySelector('.c-edit-input');
        editWrap.classList.add('show');
        bodyEl.classList.add('hidden');
        input.value = bodyEl.textContent;
        input.focus();
        return;
      }

      // Cancel edit
      if (e.target.closest('.c-edit-cancel')){
        const bodyEl   = card.querySelector('.c-text');
        const editWrap = card.querySelector('.c-edit');
        editWrap.classList.remove('show');
        bodyEl.classList.remove('hidden');
        return;
      }

      // Save edit
      if (e.target.closest('.c-edit-save')){
        const input = card.querySelector('.c-edit-input');
        const newText = (input.value||'').trim();
        if (!newText) return;
        try{
          const res = await fetch(API_EDIT(id), {
            method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: newText })
          });
          if (res.ok) loadComments();
        }catch(err){ console.error(err); }
        return;
      }

      // Delete
      if (e.target.closest('.c-del-btn')){
        if (!confirm('Delete this comment?')) return;
        try{
          const res = await fetch(API_EDIT(id), { method:'DELETE' });
          if (res.ok) loadComments();
        }catch(err){ console.error(err); }
        return;
      }
    });

    loadComments();
  })();

    (function() {
    const shareBtn = document.getElementById("shareBtn");
    if (!shareBtn) return;

    shareBtn.addEventListener("click", () => {
      const url = window.location.href;
      const titleEl = document.querySelector(".article-title");
      const title = titleEl ? titleEl.innerText : document.title;

      if (navigator.share) {
        navigator.share({
          title: title,
          url: url
        }).catch(err => console.error("Share failed:", err));
      } else {
        navigator.clipboard.writeText(url).then(() => {
          alert("Link copied to clipboard!");
        });
      }
    });
  })();
  </script>

</body>
</html>
