<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>EchoPress</title>
    <link rel="stylesheet" href="../static/css/style.css" />
    <link rel="stylesheet" href="../static/css/accessibility_toolbar.css" />
    <link rel="icon" href="../static/img/EchoPressLogo.png" type="image/png" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <a href="/" class="logo">EchoPress</a>
      <div class="auth-buttons">
        <a href="/login" class="signin">Sign In</a>
        <a href="/register" class="register">Register</a>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="navbar">
      <a href="{{ url_for('index') }}">For You</a>
      {% for cat in nav_categories %}
      <a href="{{ url_for('category', category_name=cat['name']) }}"
        >{{ cat['name'] }}</a
      >
      {% endfor %}
    </nav>


    <!-- Main Content -->
    <main class="main-content">
      <!-- Articles -->
      <section class="articles">
        <article class="article sel-article">
          <div class="text">
            <h1 class="main-title">{{ article['title'] }}</h1>

            {% include 'partials/accessibility_toolbar.html' %}

            {% if article['image'] %}

              <div style="margin: 15px 20px;">
              <label for="language">Translate to:</label>
              <select id="language" onchange="translateArticle()">
                <option value="en">English (Default)</option>
                <optgroup label="Asian Languages">
                  <option value="zh-CN">Chinese (Simplified)</option>
                  <option value="ms">Malay</option>
                  <option value="ko">Korean</option>
                  <option value="ja">Japanese</option>
                  <option value="vi">Vietnamese</option>
                </optgroup>

                <optgroup label="European Languages">
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="nl">Dutch</option>
                  <option value="ru">Russian</option>
                  <option value="it">Italian</option>
                  <option value="pt">Portuguese</option>
                </optgroup>
              </select>
            </div>

            <img src="{{ article['image'] }}" alt="thumbnail" class="image" />
            {% endif %}

            <!-- AI summarizer section -->
            {% if summary_points %} 
            <div class="summary-box">
              <h3>Summary</h3>
              <ul style="margin-left: 30px;">
                {% for point in summary_points %}
                <li>{{ point }}</li>
                 {% endfor %}
              </ul>
            </div>
             {% endif %}  

            <p class="small-text">{{ article['content'] }}</p>
            <p>
              Author: {{ article['author'] }} <br />
              Published: {{ article['published_at'] }} <br />
              Updated: {{ article['updated_at'] }}
            </p>
            <div class="share-button">
              <button onclick="shareArticle()" title="Share">
                <img
                  src="{{ url_for('static', filename='img/share.png') }}"
                  alt="Share"
                  class="share-icon"
                />
              </button>
            </div>
          </div>
        </article>
      </section>

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="register-box">
          <p>
            Join us now as a registered member and be part of our discussion
            community!
          </p>
          <a href="/register" class="register">Register for Free</a>
        </div>
        <div class="ads">
          <h3>Ads</h3>
        </div>
      </aside>
    </main>

    <script>
      // for Multilingual Support
      // storing original english(default) ver
      let originalTitle = "";
      let originalContent = "";
      let originalSummary = [];

      window.addEventListener("DOMContentLoaded", () => {
        originalTitle = document.querySelector(".main-title")?.innerText || "";
        originalContent = document.querySelector(".small-text")?.innerText || "";
        originalSummary = Array.from(document.querySelectorAll("ul li")).map(li => li.innerText);
      });

      function translateArticle() {
        const lang = document.getElementById("language").value;
        if (!lang) return;

        // restore original article when user select English
        if (lang == "en") {
          console.log("Restoring to original english version..");
          document.querySelector(".main-title").innerText = originalTitle;
          document.querySelector(".small-text").innerText = originalContent;

          const summaryList = document.querySelectorAll("ul li");
          originalSummary.forEach((t, i) => {
            if (summaryList[i]) summaryList[i].innerText = t;
          });
          return;
        }

        // translating from original english text
        fetch("/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: originalTitle,
            content: originalContent,              
            summary: originalSummary,
            target_lang: lang
            }),
        })
        .then((res) => res.json())
        .then((data) => {
          console.log("Translated data:", data);
          if (data.error) throw new Error(data.error);

          document.querySelector(".main-title").innerText = data.title || originalTitle;
          document.querySelector(".small-text").innerText = data.content || originalContent;

          const summaryList = document.querySelectorAll("ul li");
            data.summary?.forEach((t, i) => {
              if (summaryList[i]) summaryList[i].innerText = t;
            });
          })
          .catch((err) => console.error("Translation error:", err));
        }
        
      function shareArticle() {
        const url = window.location.href;
        const title = document.querySelector(".main-title").innerText;

        if (navigator.share) {
          // Native share on mobile
          navigator
            .share({
              title: title,
              url: url,
            })
            .catch((err) => console.log("Share failed:", err));
        } else {
          // Fallback for desktop
          navigator.clipboard.writeText(url).then(() => {
            alert("Link copied to clipboard!");
          });
        }
      }
    </script>
    <script src="{{ url_for('static', filename='js/accessibility_toolbar.js') }}"></script>

    <script>
      (function () {
        // Try common keys: articleID or id
        const ARTICLE_ID = {{ article.get('articleID') or article.get('id') or 0 }};
        if (!ARTICLE_ID) return;

        // Fire a beacon to increment views once per session
        fetch(`/api/article/${ARTICLE_ID}/view`, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).catch(() => {/* silent */});
      })();
    </script>
    {% include 'partials/chatbot.html' %}
  </body>
</html>
